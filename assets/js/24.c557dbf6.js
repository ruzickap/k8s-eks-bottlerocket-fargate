(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{315:function(s,a,e){"use strict";e.r(a);var t=e(8),r=Object(t.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"aws"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#aws"}},[s._v("#")]),s._v(" AWS")]),s._v(" "),a("p",[s._v("Add EKS helm repository:")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("helm repo "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" --force-update eks https://aws.github.io/eks-charts\n")])])]),a("h2",{attrs:{id:"fargate"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#fargate"}},[s._v("#")]),s._v(" Fargate")]),s._v(" "),a("p",[s._v("Attach the policy to the "),a("a",{attrs:{href:"https://docs.aws.amazon.com/eks/latest/userguide/pod-execution-role.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("pod execution role"),a("OutboundLink")],1),s._v("\nof your EKS on Fargate cluster:")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("FARGATE_POD_EXECUTION_ROLE_ARN")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("eksctl get iamidentitymapping "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_NAME}")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" json "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" jq "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(' ".'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(".rolearn "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" contains"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v('"FargatePodExecutionRole'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v('"'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v(" .rolearn"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('")\naws iam attach-role-policy --policy-arn "')]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLOUDWATCH_POLICY_ARN}")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('" --role-name "')]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${FARGATE_POD_EXECUTION_ROLE_ARN"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("#")]),s._v("*"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("}")]),s._v('"\n')])])]),a("p",[s._v("Create the dedicated "),a("code",[s._v("aws-observability")]),s._v(" namespace and the ConfigMap for Fluent Bit:")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" - "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\nkind: Namespace\napiVersion: v1\nmetadata:\n  name: aws-observability\n  labels:\n    aws-observability: enabled\n---\nkind: ConfigMap\napiVersion: v1\nmetadata:\n  name: aws-logging\n  namespace: aws-observability\ndata:\n  output.conf: |\n    [OUTPUT]\n        Name cloudwatch_logs\n        Match   *\n        region "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${AWS_DEFAULT_REGION}")]),s._v("\n        log_group_name /aws/eks/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_FQDN}")]),s._v("/logs\n        log_stream_prefix fluentbit-\n        auto_create_group true\nEOF")]),s._v("\n")])])]),a("p",[s._v("All the Fargate pods should now send the log to CloudWatch...")]),s._v(" "),a("h2",{attrs:{id:"aws-load-balancer-controller"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#aws-load-balancer-controller"}},[s._v("#")]),s._v(" aws-load-balancer-controller")]),s._v(" "),a("p",[s._v("Install "),a("code",[s._v("aws-load-balancer-controller")]),s._v(" "),a("a",{attrs:{href:"https://artifacthub.io/packages/helm/aws/aws-load-balancer-controller",target:"_blank",rel:"noopener noreferrer"}},[s._v("helm chart"),a("OutboundLink")],1),s._v("\nand modify the\n"),a("a",{attrs:{href:"https://github.com/aws/eks-charts/blob/master/stable/aws-load-balancer-controller/values.yaml",target:"_blank",rel:"noopener noreferrer"}},[s._v("default values"),a("OutboundLink")],1),s._v(".")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("helm upgrade "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--install")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--version")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.2")]),s._v(".6 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--namespace")]),s._v(" kube-system "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--values")]),s._v(" - aws-load-balancer-controller eks/aws-load-balancer-controller "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\nclusterName: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_NAME}")]),s._v("\nserviceAccount:\n  create: false\n  name: aws-load-balancer-controller\nenableShield: false\nenableWaf: false\nenableWafv2: false\n# Needed for Calico\nhostNetwork: true\ndefaultTags:\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${TAGS}")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s/ /'),a("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v('n  /g; s/^/  /g; s/=/: /g"')]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\nEOF")]),s._v("\n")])])]),a("p",[s._v("It seems like there are some issues with ALB and cert-manager / Istio:")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://github.com/kubernetes-sigs/aws-load-balancer-controller/issues/1084",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/kubernetes-sigs/aws-load-balancer-controller/issues/1084"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/kubernetes-sigs/aws-load-balancer-controller/issues/1143",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/kubernetes-sigs/aws-load-balancer-controller/issues/1143"),a("OutboundLink")],1)])]),s._v(" "),a("p",[s._v('I\'ll use NLB as main "Load Balancer type" in AWS.')]),s._v(" "),a("h2",{attrs:{id:"aws-for-fluent-bit"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#aws-for-fluent-bit"}},[s._v("#")]),s._v(" aws-for-fluent-bit")]),s._v(" "),a("p",[s._v("Install "),a("code",[s._v("aws-for-fluent-bit")]),s._v(" "),a("a",{attrs:{href:"https://artifacthub.io/packages/helm/aws/aws-for-fluent-bit",target:"_blank",rel:"noopener noreferrer"}},[s._v("helm chart"),a("OutboundLink")],1),s._v("\nand modify the\n"),a("a",{attrs:{href:"https://github.com/aws/eks-charts/blob/master/stable/aws-for-fluent-bit/values.yaml",target:"_blank",rel:"noopener noreferrer"}},[s._v("default values"),a("OutboundLink")],1),s._v(".")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("helm upgrade "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--install")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--version")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.1")]),s._v(".11 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--namespace")]),s._v(" kube-system "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--values")]),s._v(" - aws-for-fluent-bit eks/aws-for-fluent-bit "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\ncloudWatch:\n  region: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${AWS_DEFAULT_REGION}")]),s._v("\n  logGroupName: /aws/eks/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_FQDN}")]),s._v("/logs\nfirehose:\n  enabled: false\nkinesis:\n  enabled: false\nelasticsearch:\n  enabled: false\nEOF")]),s._v("\n")])])]),a("p",[s._v("The "),a("code",[s._v("aws-for-fluent-bit")]),s._v(" will create Log group "),a("code",[s._v("/aws/eks/kube1.k8s.mylabs.dev/logs")]),s._v("\nand stream the logs from all pods there.")]),s._v(" "),a("h2",{attrs:{id:"aws-cloudwatch-metrics"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#aws-cloudwatch-metrics"}},[s._v("#")]),s._v(" aws-cloudwatch-metrics")]),s._v(" "),a("p",[s._v("Install "),a("code",[s._v("aws-cloudwatch-metrics")]),s._v(" "),a("a",{attrs:{href:"https://artifacthub.io/packages/helm/aws/aws-cloudwatch-metrics",target:"_blank",rel:"noopener noreferrer"}},[s._v("helm chart"),a("OutboundLink")],1),s._v("\nand modify the\n"),a("a",{attrs:{href:"https://github.com/aws/eks-charts/blob/master/stable/aws-cloudwatch-metrics/values.yaml",target:"_blank",rel:"noopener noreferrer"}},[s._v("default values"),a("OutboundLink")],1),s._v(".")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("helm upgrade "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--install")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--version")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".5 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--namespace")]),s._v(" amazon-cloudwatch --create-namespace "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--values")]),s._v(" - aws-cloudwatch-metrics eks/aws-cloudwatch-metrics "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\nclusterName: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_FQDN}")]),s._v("\nEOF")]),s._v("\n")])])]),a("p",[s._v("The "),a("code",[s._v("aws-cloudwatch-metrics")]),s._v(' populates "Container insights" in CloudWatch...')]),s._v(" "),a("h2",{attrs:{id:"aws-efs-csi-driver"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#aws-efs-csi-driver"}},[s._v("#")]),s._v(" aws-efs-csi-driver")]),s._v(" "),a("p",[s._v("Get the details about the VPC to be able to configure security groups for EFS:")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("EKS_VPC_ID")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("aws eks describe-cluster "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_NAME}")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--query")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cluster.resourcesVpcConfig.vpcId"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--output")]),s._v(" text"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("EKS_VPC_CIDR")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("aws ec2 describe-vpcs --vpc-ids "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${EKS_VPC_ID}")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--query")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Vpcs[].CidrBlock"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--output")]),s._v(" text"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n")])])]),a("p",[s._v("Create EFS using CloudFormation:")]),s._v(" "),a("p",[s._v("Apply CloudFormation template to create Amazon EFS.\nThe template below is inspired by: "),a("a",{attrs:{href:"https://github.com/so008mo/inkubator-play/blob/64a150dbdc35b9ade48ff21b9ae6ba2710d18b5d/roles/eks/files/amazon-eks-efs.yaml",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/so008mo/inkubator-play/blob/64a150dbdc35b9ade48ff21b9ae6ba2710d18b5d/roles/eks/files/amazon-eks-efs.yaml"),a("OutboundLink")],1)]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tmp/'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_FQDN}")]),s._v('/cf_efs.yml"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("EOF\nAWSTemplateFormatVersion: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2010")]),s._v("-09-09\nDescription: Create EFS, "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mount")]),s._v(" points, security "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("groups")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" EKS\nParameters:\n  ClusterName:\n    Description: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"K8s Cluster name. Ex: kube1"')]),s._v("\n    Type: String\n  KmsKeyId:\n    Description: The ID of the AWS KMS customer master key "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("CMK"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" to be used to protect the encrypted "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" system\n    Type: String\n  VpcIPCidr:\n    Description: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Enter VPC CIDR that hosts the EKS cluster. Ex: 10.0.0.0/16"')]),s._v("\n    Type: String\nResources:\n  MountTargetSecurityGroup:\n    Type: AWS::EC2::SecurityGroup\n    Properties:\n      VpcId:\n        Fn::ImportValue:\n          Fn::Sub: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eksctl-'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ClusterName}")]),s._v('-cluster::VPC"')]),s._v("\n      GroupName: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("Sub "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ClusterName}")]),s._v('-efs-sg"')]),s._v("\n      GroupDescription: Security group "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("mount")]),s._v(" target\n      SecurityGroupIngress:\n        - IpProtocol: tcp\n          FromPort: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2049"')]),s._v("\n          ToPort: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2049"')]),s._v("\n          CidrIp:\n            Ref: VpcIPCidr\n      Tags:\n        - Key: Name\n          Value: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("Sub "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ClusterName}")]),s._v('-efs-sg"')]),s._v("\n  FileSystemDrupal:\n    Type: AWS::EFS::FileSystem\n    Properties:\n      Encrypted: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n      FileSystemTags:\n      - Key: Name\n        Value: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("Sub "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ClusterName}")]),s._v('-efs-drupal"')]),s._v("\n      KmsKeyId: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("Ref KmsKeyId\n  MountTargetAZ1:\n    Type: AWS::EFS::MountTarget\n    Properties:\n      FileSystemId:\n        Ref: FileSystemDrupal\n      SubnetId:\n        Fn::Select:\n        - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n        - Fn::Split:\n          - "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('","')]),s._v("\n          - Fn::ImportValue: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("Sub "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eksctl-'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ClusterName}")]),s._v('-cluster::SubnetsPrivate"')]),s._v("\n      SecurityGroups:\n      - Ref: MountTargetSecurityGroup\n  MountTargetAZ2:\n    Type: AWS::EFS::MountTarget\n    Properties:\n      FileSystemId:\n        Ref: FileSystemDrupal\n      SubnetId:\n        Fn::Select:\n        - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n        - Fn::Split:\n          - "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('","')]),s._v("\n          - Fn::ImportValue: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("Sub "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eksctl-'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ClusterName}")]),s._v('-cluster::SubnetsPrivate"')]),s._v("\n      SecurityGroups:\n      - Ref: MountTargetSecurityGroup\n  AccessPointDrupal1:\n    Type: AWS::EFS::AccessPoint\n    Properties:\n      FileSystemId: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("Ref FileSystemDrupal\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Set proper uid/gid: https://github.com/bitnami/bitnami-docker-drupal/blob/02f7e41c88eee96feb90c8b7845ee7aeb5927c38/9/debian-10/Dockerfile#L49")]),s._v("\n      PosixUser:\n        Uid: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1001"')]),s._v("\n        Gid: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1001"')]),s._v("\n      RootDirectory:\n        CreationInfo:\n          OwnerGid: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1001"')]),s._v("\n          OwnerUid: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1001"')]),s._v("\n          Permissions: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"700"')]),s._v("\n        Path: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/drupal1"')]),s._v("\n      AccessPointTags:\n        - Key: Name\n          Value: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("Sub "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ClusterName}")]),s._v('-drupal1-ap"')]),s._v("\n  AccessPointDrupal2:\n    Type: AWS::EFS::AccessPoint\n    Properties:\n      FileSystemId: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("Ref FileSystemDrupal\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Set proper uid/gid: https://github.com/bitnami/bitnami-docker-drupal/blob/02f7e41c88eee96feb90c8b7845ee7aeb5927c38/9/debian-10/Dockerfile#L49")]),s._v("\n      PosixUser:\n        Uid: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1001"')]),s._v("\n        Gid: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1001"')]),s._v("\n      RootDirectory:\n        CreationInfo:\n          OwnerGid: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1001"')]),s._v("\n          OwnerUid: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1001"')]),s._v("\n          Permissions: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"700"')]),s._v("\n        Path: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/drupal2"')]),s._v("\n      AccessPointTags:\n        - Key: Name\n          Value: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("Sub "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ClusterName}")]),s._v('-drupal2-ap"')]),s._v("\n  FileSystemMyuser1:\n    Type: AWS::EFS::FileSystem\n    Properties:\n      Encrypted: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n      FileSystemTags:\n      - Key: Name\n        Value: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("Sub "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ClusterName}")]),s._v('-myuser1"')]),s._v("\n      KmsKeyId: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("Ref KmsKeyId\n  MountTargetAZ1Myuser1:\n    Type: AWS::EFS::MountTarget\n    Properties:\n      FileSystemId:\n        Ref: FileSystemMyuser1\n      SubnetId:\n        Fn::Select:\n        - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n        - Fn::Split:\n          - "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('","')]),s._v("\n          - Fn::ImportValue: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("Sub "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eksctl-'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ClusterName}")]),s._v('-cluster::SubnetsPrivate"')]),s._v("\n      SecurityGroups:\n      - Ref: MountTargetSecurityGroup\n  MountTargetAZ2Myuser1:\n    Type: AWS::EFS::MountTarget\n    Properties:\n      FileSystemId:\n        Ref: FileSystemMyuser1\n      SubnetId:\n        Fn::Select:\n        - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n        - Fn::Split:\n          - "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('","')]),s._v("\n          - Fn::ImportValue: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("Sub "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eksctl-'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ClusterName}")]),s._v('-cluster::SubnetsPrivate"')]),s._v("\n      SecurityGroups:\n      - Ref: MountTargetSecurityGroup\n  AccessPointMyuser1:\n    Type: AWS::EFS::AccessPoint\n    Properties:\n      FileSystemId: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("Ref FileSystemMyuser1\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Set proper uid/gid: https://github.com/bitnami/bitnami-docker-drupal/blob/02f7e41c88eee96feb90c8b7845ee7aeb5927c38/9/debian-10/Dockerfile#L49")]),s._v("\n      RootDirectory:\n        CreationInfo:\n          OwnerGid: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1000"')]),s._v("\n          OwnerUid: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1000"')]),s._v("\n          Permissions: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"700"')]),s._v("\n        Path: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/myuser1"')]),s._v("\n      AccessPointTags:\n        - Key: Name\n          Value: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("Sub "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ClusterName}")]),s._v('-myuser1"')]),s._v("\n  FileSystemMyuser2:\n    Type: AWS::EFS::FileSystem\n    Properties:\n      Encrypted: "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n      FileSystemTags:\n      - Key: Name\n        Value: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("Sub "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ClusterName}")]),s._v('-myuser2"')]),s._v("\n      KmsKeyId: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("Ref KmsKeyId\n  MountTargetAZ1Myuser2:\n    Type: AWS::EFS::MountTarget\n    Properties:\n      FileSystemId:\n        Ref: FileSystemMyuser2\n      SubnetId:\n        Fn::Select:\n        - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n        - Fn::Split:\n          - "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('","')]),s._v("\n          - Fn::ImportValue: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("Sub "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eksctl-'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ClusterName}")]),s._v('-cluster::SubnetsPrivate"')]),s._v("\n      SecurityGroups:\n      - Ref: MountTargetSecurityGroup\n  MountTargetAZ2Myuser2:\n    Type: AWS::EFS::MountTarget\n    Properties:\n      FileSystemId:\n        Ref: FileSystemMyuser2\n      SubnetId:\n        Fn::Select:\n        - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n        - Fn::Split:\n          - "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('","')]),s._v("\n          - Fn::ImportValue: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("Sub "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"eksctl-'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ClusterName}")]),s._v('-cluster::SubnetsPrivate"')]),s._v("\n      SecurityGroups:\n      - Ref: MountTargetSecurityGroup\n  AccessPointMyuser2:\n    Type: AWS::EFS::AccessPoint\n    Properties:\n      FileSystemId: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("Ref FileSystemMyuser2\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Set proper uid/gid: https://github.com/bitnami/bitnami-docker-drupal/blob/02f7e41c88eee96feb90c8b7845ee7aeb5927c38/9/debian-10/Dockerfile#L49")]),s._v("\n      RootDirectory:\n        CreationInfo:\n          OwnerGid: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1000"')]),s._v("\n          OwnerUid: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1000"')]),s._v("\n          Permissions: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"700"')]),s._v("\n        Path: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/myuser2"')]),s._v("\n      AccessPointTags:\n        - Key: Name\n          Value: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v("Sub "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${ClusterName}")]),s._v('-myuser2"')]),s._v("\nOutputs:\n  FileSystemIdDrupal:\n    Description: Id of Elastic File System\n    Value:\n      Ref: FileSystemDrupal\n    Export:\n      Name:\n        Fn::Sub: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${AWS"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("StackName}")]),s._v('-FileSystemIdDrupal"')]),s._v("\n  AccessPointIdDrupal1:\n    Description: EFS AccessPoint ID "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" Drupal1\n    Value:\n      Ref: AccessPointDrupal1\n    Export:\n      Name:\n        Fn::Sub: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${AWS"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("StackName}")]),s._v('-AccessPointIdDrupal1"')]),s._v("\n  AccessPointIdDrupal2:\n    Description: EFS AccessPoint2 ID "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" Drupal2\n    Value:\n      Ref: AccessPointDrupal2\n    Export:\n      Name:\n        Fn::Sub: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${AWS"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("StackName}")]),s._v('-AccessPointIdDrupal2"')]),s._v("\n  FileSystemIdMyuser1:\n    Description: Id of Elastic File System Myuser1\n    Value:\n      Ref: FileSystemMyuser1\n    Export:\n      Name:\n        Fn::Sub: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${AWS"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("StackName}")]),s._v('-FileSystemIdMyuser1"')]),s._v("\n  AccessPointIdMyuser1:\n    Description: EFS AccessPoint2 ID "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" Myuser1\n    Value:\n      Ref: AccessPointMyuser1\n    Export:\n      Name:\n        Fn::Sub: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${AWS"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("StackName}")]),s._v('-AccessPointIdMyuser1"')]),s._v("\n  FileSystemIdMyuser2:\n    Description: ID of Elastic File System Myuser2\n    Value:\n      Ref: FileSystemMyuser2\n    Export:\n      Name:\n        Fn::Sub: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${AWS"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("StackName}")]),s._v('-FileSystemIdMyuser2"')]),s._v("\n  AccessPointIdMyuser2:\n    Description: EFS AccessPoint2 ID "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" Myuser2\n    Value:\n      Ref: AccessPointMyuser2\n    Export:\n      Name:\n        Fn::Sub: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${AWS"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("StackName}")]),s._v('-AccessPointIdMyuser2"')]),s._v("\nEOF\n\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("eval")]),s._v(" aws cloudformation deploy --stack-name "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_NAME}")]),s._v('-efs"')]),s._v(" --parameter-overrides "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ClusterName='),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_NAME}")]),s._v(" KmsKeyId="),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${KMS_KEY_ID}")]),s._v(" VpcIPCidr="),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${EKS_VPC_CIDR}")]),s._v('"')]),s._v(" --template-file "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tmp/'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_FQDN}")]),s._v('/cf_efs.yml"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--tags")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${TAGS}")]),s._v('"')]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("AWS_CLOUDFORMATION_DETAILS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("aws cloudformation describe-stacks --stack-name "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_NAME}")]),s._v('-efs"')]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("EFS_FS_ID_DRUPAL")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${AWS_CLOUDFORMATION_DETAILS}")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" jq "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('".Stacks[0].Outputs[] | select(.OutputKey=='),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("FileSystemIdDrupal"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(') .OutputValue"')]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("EFS_AP_ID_DRUPAL1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${AWS_CLOUDFORMATION_DETAILS}")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" jq "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('".Stacks[0].Outputs[] | select(.OutputKey=='),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("AccessPointIdDrupal1"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(') .OutputValue"')]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("EFS_AP_ID_DRUPAL2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${AWS_CLOUDFORMATION_DETAILS}")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" jq "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('".Stacks[0].Outputs[] | select(.OutputKey=='),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("AccessPointIdDrupal2"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(') .OutputValue"')]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("EFS_FS_ID_MYUSER1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${AWS_CLOUDFORMATION_DETAILS}")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" jq "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('".Stacks[0].Outputs[] | select(.OutputKey=='),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("FileSystemIdMyuser1"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(') .OutputValue"')]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("EFS_AP_ID_MYUSER1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${AWS_CLOUDFORMATION_DETAILS}")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" jq "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('".Stacks[0].Outputs[] | select(.OutputKey=='),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("AccessPointIdMyuser1"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(') .OutputValue"')]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("EFS_FS_ID_MYUSER2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${AWS_CLOUDFORMATION_DETAILS}")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" jq "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('".Stacks[0].Outputs[] | select(.OutputKey=='),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("FileSystemIdMyuser2"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(') .OutputValue"')]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("EFS_AP_ID_MYUSER2")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${AWS_CLOUDFORMATION_DETAILS}")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" jq "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('".Stacks[0].Outputs[] | select(.OutputKey=='),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("AccessPointIdMyuser2"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(') .OutputValue"')]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n")])])]),a("p",[s._v("Install "),a("a",{attrs:{href:"https://github.com/kubernetes-sigs/aws-efs-csi-driver",target:"_blank",rel:"noopener noreferrer"}},[s._v("Amazon EFS CSI Driver"),a("OutboundLink")],1),s._v(",\nwhich supports ReadWriteMany PVC. Details can be found here:\n"),a("a",{attrs:{href:"https://aws.amazon.com/blogs/containers/introducing-efs-csi-dynamic-provisioning/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Introducing Amazon EFS CSI dynamic provisioning"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("Install "),a("a",{attrs:{href:"https://github.com/kubernetes-sigs/aws-efs-csi-driver",target:"_blank",rel:"noopener noreferrer"}},[s._v("Amazon EFS CSI Driver"),a("OutboundLink")],1),s._v(" "),a("code",[s._v("aws-efs-csi-driver")]),s._v(" "),a("a",{attrs:{href:"https://github.com/kubernetes-sigs/aws-efs-csi-driver/tree/master/charts/aws-efs-csi-driver",target:"_blank",rel:"noopener noreferrer"}},[s._v("helm chart"),a("OutboundLink")],1),s._v("\nand modify the\n"),a("a",{attrs:{href:"https://github.com/kubernetes-sigs/aws-efs-csi-driver/blob/master/charts/aws-efs-csi-driver/values.yaml",target:"_blank",rel:"noopener noreferrer"}},[s._v("default values"),a("OutboundLink")],1),s._v(":")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("helm repo "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" --force-update aws-efs-csi-driver https://kubernetes-sigs.github.io/aws-efs-csi-driver/\nhelm upgrade "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--install")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--version")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.1")]),s._v(".5 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--namespace")]),s._v(" kube-system "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--values")]),s._v(" - aws-efs-csi-driver aws-efs-csi-driver/aws-efs-csi-driver "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\ncontroller:\n  serviceAccount:\n    create: false\nstorageClasses:\n- name: efs-drupal-dynamic\n  parameters:\n    provisioningMode: efs-ap\n    fileSystemId: "'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${EFS_FS_ID_DRUPAL}")]),s._v('"\n    directoryPerms: "700"\n    basePath: "/dynamic_provisioning"\n  reclaimPolicy: Delete\n- name: efs-drupal-static\n  parameters:\n    provisioningMode: efs-ap\n    fileSystemId: "'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${EFS_FS_ID_DRUPAL}")]),s._v('"\n    directoryPerms: "700"\n  reclaimPolicy: Delete\n- name: efs-myuser1-sc\n  parameters:\n    provisioningMode: efs-ap\n    fileSystemId: "'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${EFS_FS_ID_MYUSER1}")]),s._v('"\n    directoryPerms: "700"\n  reclaimPolicy: Delete\n- name: efs-myuser2-sc\n  parameters:\n    provisioningMode: efs-ap\n    fileSystemId: "'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${EFS_FS_ID_MYUSER2}")]),s._v('"\n    directoryPerms: "700"\n  reclaimPolicy: Delete\nEOF')]),s._v("\n")])])]),a("p",[s._v("Create "),a("code",[s._v("PersistentVolume")]),s._v("s which can be consumed by users ("),a("code",[s._v("myuser1")]),s._v(", "),a("code",[s._v("myuser2")]),s._v(")\nusing "),a("code",[s._v("PersistentVolumeClaim")]),s._v(":")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" - "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: efs-myuser1-pv\nspec:\n  storageClassName: efs-myuser1-sc\n  capacity:\n    storage: 1Gi\n  volumeMode: Filesystem\n  accessModes:\n    - ReadWriteMany\n  persistentVolumeReclaimPolicy: Delete\n  csi:\n    driver: efs.csi.aws.com\n    volumeHandle: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${EFS_FS_ID_MYUSER1}")]),s._v("::"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${EFS_AP_ID_MYUSER1}")]),s._v("\n---\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: efs-myuser2-pv\nspec:\n  storageClassName: efs-myuser2-sc\n  capacity:\n    storage: 1Gi\n  volumeMode: Filesystem\n  accessModes:\n    - ReadWriteMany\n  persistentVolumeReclaimPolicy: Delete\n  csi:\n    driver: efs.csi.aws.com\n    volumeHandle: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${EFS_FS_ID_MYUSER2}")]),s._v("::"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${EFS_AP_ID_MYUSER2}")]),s._v("\nEOF")]),s._v("\n")])])]),a("h2",{attrs:{id:"install-external-snapshotter"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#install-external-snapshotter"}},[s._v("#")]),s._v(" Install external-snapshotter")]),s._v(" "),a("p",[s._v("Details about EKS and external-snapshotter can be found here: "),a("a",{attrs:{href:"https://aws.amazon.com/blogs/containers/using-ebs-snapshots-for-persistent-storage-with-your-eks-cluster",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://aws.amazon.com/blogs/containers/using-ebs-snapshots-for-persistent-storage-with-your-eks-cluster"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("Install  Volume Snapshot Custom Resource Definitions (CRDs)")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/master/client/config/crd/snapshot.storage.k8s.io_volumesnapshotclasses.yaml\nkubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/master/client/config/crd/snapshot.storage.k8s.io_volumesnapshotcontents.yaml\nkubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/master/client/config/crd/snapshot.storage.k8s.io_volumesnapshots.yaml\n")])])]),a("p",[s._v("Install Common Snapshot Controller:")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/master/deploy/kubernetes/snapshot-controller/rbac-snapshot-controller.yaml\nkubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/master/deploy/kubernetes/snapshot-controller/setup-snapshot-controller.yaml\n")])])]),a("h2",{attrs:{id:"aws-ebs-csi-driver"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#aws-ebs-csi-driver"}},[s._v("#")]),s._v(" aws-ebs-csi-driver")]),s._v(" "),a("p",[s._v("Install Amazon EBS CSI Driver "),a("code",[s._v("aws-ebs-csi-driver")]),s._v(" "),a("a",{attrs:{href:"https://github.com/kubernetes-sigs/aws-ebs-csi-driver/tree/master/charts/aws-ebs-csi-driver",target:"_blank",rel:"noopener noreferrer"}},[s._v("helm chart"),a("OutboundLink")],1),s._v("\nand modify the\n"),a("a",{attrs:{href:"https://github.com/kubernetes-sigs/aws-ebs-csi-driver/blob/master/charts/aws-ebs-csi-driver/values.yaml",target:"_blank",rel:"noopener noreferrer"}},[s._v("default values"),a("OutboundLink")],1),s._v(":\nThe ServiceAccount "),a("code",[s._v("ebs-csi-controller-sa")]),s._v(" was created by "),a("code",[s._v("eksctl")]),s._v(".")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("helm repo "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" --force-update aws-ebs-csi-driver https://kubernetes-sigs.github.io/aws-ebs-csi-driver\nhelm upgrade "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--install")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--version")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.4")]),s._v(".0 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--namespace")]),s._v(" kube-system "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--values")]),s._v(" - aws-ebs-csi-driver aws-ebs-csi-driver/aws-ebs-csi-driver "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\ncontroller:\n  extraVolumeTags:\n    Cluster: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_FQDN}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${TAGS}")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s/ /'),a("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[s._v("\\\\")]),s._v('n    /g; s/=/: /g"')]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n  serviceAccount:\n    create: false\n    name: ebs-csi-controller-sa\n  region: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${AWS_DEFAULT_REGION}")]),s._v('\nstorageClasses:\n- name: gp3\n  annotations:\n    storageclass.kubernetes.io/is-default-class: "true"\n  parameters:\n    encrypted: "true"\nEOF')]),s._v("\n")])])]),a("p",[s._v("Unset "),a("code",[s._v("gp2")]),s._v(" as default StorageClass annotation:")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl patch storageclass gp2 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{'),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("metadata"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(": {"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("annotations"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(":{"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("storageclass.kubernetes.io/is-default-class"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v(":"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v("false"),a("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[s._v('\\"')]),s._v('}}}"')]),s._v("\n")])])]),a("p",[s._v("Create the Volume Snapshot Class:")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" - "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("EOF\napiVersion: snapshot.storage.k8s.io/v1\nkind: VolumeSnapshotClass\nmetadata:\n  name: csi-ebs-snapclass\n  labels:\n    velero.io/csi-volumesnapshot-class: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\n    snapshot.storage.kubernetes.io/is-default-class: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"true"')]),s._v("\ndriver: ebs.csi.aws.com\ndeletionPolicy: Retain\nEOF\n")])])]),a("h2",{attrs:{id:"test-amazon-eks-pod-limits"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#test-amazon-eks-pod-limits"}},[s._v("#")]),s._v(" Test Amazon EKS pod limits")]),s._v(" "),a("p",[s._v('By default, there is certain number of pods which can be run on Amazon EKS\nworker nodes. The "max number of pods" depends on node type an you can read\nabout it on these links:')]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://github.com/awslabs/amazon-eks-ami/blob/e566fe08ea09186120bdaa582d8ccf6461ca66d6/files/eni-max-pods.txt",target:"_blank",rel:"noopener noreferrer"}},[s._v("eni-max-pods.txt"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html#AvailableIpPerENI",target:"_blank",rel:"noopener noreferrer"}},[s._v("Elastic network interfaces"),a("OutboundLink")],1)]),s._v(" "),a("li",[a("a",{attrs:{href:"https://stackoverflow.com/questions/57970896/pod-limit-on-node-aws-eks/57971006",target:"_blank",rel:"noopener noreferrer"}},[s._v("Pod limit on Node - AWS EKS"),a("OutboundLink")],1)])]),s._v(" "),a("p",[s._v("I would like to put some notes here how this can be tested...")]),s._v(" "),a("p",[s._v("Start the EKS cluster with "),a("code",[s._v("t2.micro")]),s._v(" where you can run max 4 pods per node:")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("eksctl create cluster "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" test-max-pod "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--region")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${AWS_DEFAULT_REGION}")]),s._v('"')]),s._v(" --node-type"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("t2.micro "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--nodes")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" --node-volume-size"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kubeconfig-test-max-pod.conf"')]),s._v(" --max-pods-per-node "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\n")])])]),a("p",[s._v("Show the limits of the node, which can not be fulfilled due to IP limitations:")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("kubectl describe nodes "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pods:"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("uniq")]),s._v("\n")])])]),a("p",[s._v("Output:")]),s._v(" "),a("div",{staticClass:"language-text extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("  pods:                        1k\n")])])]),a("p",[s._v("Run 3 "),a("code",[s._v("nginx")]),s._v(" pods:")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" https://k8s.io/examples/controllers/nginx-deployment.yaml\n")])])]),a("p",[s._v("One of them will fail:")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("kubectl describe pod\n")])])]),a("p",[s._v("Output:")]),s._v(" "),a("div",{staticClass:"language-text extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('...\n  Warning  FailedCreatePodSandBox  33s                 kubelet            Failed to create pod sandbox: rpc error: code = Unknown desc = failed to set up sandbox container "738ecb9c495143df8647e69e70d19181643ebda1d3ce5d89e06526cf4285b89d" network for pod "nginx-deployment-6b474476c4-df8rz": networkPlugin cni failed to set up pod "nginx-deployment-6b474476c4-df8rz_default" network: add cmd: failed to assign an IP address to container\n...\n')])])]),a("p",[s._v("Delete the cluster:")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("eksctl delete cluster "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" test-max-pod "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--region")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${AWS_DEFAULT_REGION}")]),s._v('"')]),s._v("\n")])])]),a("p",[s._v("Do the same with Amazon EKS + Calico:")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("eksctl create cluster "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" test-max-pod "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--region")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${AWS_DEFAULT_REGION}")]),s._v('"')]),s._v(" --without-nodegroup "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kubeconfig-test-max-pod.conf"')]),s._v("\nkubectl delete daemonset "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" kube-system aws-node\nkubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" https://docs.projectcalico.org/manifests/calico-vxlan.yaml\neksctl create nodegroup "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),s._v(" test-max-pod "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--region")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${AWS_DEFAULT_REGION}")]),s._v('"')]),s._v(" --node-type"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("t2.micro "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--nodes")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" --node-volume-size"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" --max-pods-per-node "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),s._v("\nkubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" https://k8s.io/examples/controllers/nginx-deployment.yaml\nkubectl scale "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--replicas")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" deployment nginx-deployment\n")])])]),a("p",[s._v("Check the running pods:")]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("kubectl get pods\n")])])]),a("p",[s._v("Output:")]),s._v(" "),a("div",{staticClass:"language-text extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("NAME                                READY   STATUS    RESTARTS   AGE\nnginx-deployment-6b474476c4-26d4x   1/1     Running   0          34s\nnginx-deployment-6b474476c4-2nbnc   1/1     Running   0          70s\nnginx-deployment-6b474476c4-7cfpn   1/1     Running   0          70s\nnginx-deployment-6b474476c4-7wdk4   1/1     Running   0          2m10s\nnginx-deployment-6b474476c4-8dhmb   1/1     Running   0          34s\nnginx-deployment-6b474476c4-kp8p8   1/1     Running   0          34s\nnginx-deployment-6b474476c4-nk699   1/1     Running   0          34s\nnginx-deployment-6b474476c4-rk26b   1/1     Running   0          2m10s\nnginx-deployment-6b474476c4-x6w29   1/1     Running   0          34s\nnginx-deployment-6b474476c4-x8wkv   1/1     Running   0          2m10s\n")])])]),a("p",[s._v('It should be possible to run more pods than 4 comparing to "non-calico"\nexample.')]),s._v(" "),a("h2",{attrs:{id:"amazon-managed-prometheus-amazon-managed-grafana"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#amazon-managed-prometheus-amazon-managed-grafana"}},[s._v("#")]),s._v(" Amazon Managed Prometheus + Amazon Managed Grafana")]),s._v(" "),a("p",[s._v("Create AMP Workspace")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" aws amp list-workspaces "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-q")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_FQDN}")]),s._v('"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" aws amp create-workspace "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--alias")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_FQDN}")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" jq"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("AMP_WORKSPACE_ID")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),s._v("aws amp list-workspaces "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--alias")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_FQDN}")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" jq "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-r")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('".workspaces[0].workspaceId"')]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n")])])]),a("p",[s._v("Output:")]),s._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"arn"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"arn:aws:aps:eu-central-1:7xxxxxxxxxx7:workspace/ws-655f1f62-f1f3-4a1c-a35a-219af833c5ab"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"status"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"statusCode"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"CREATING"')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"workspaceId"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ws-655f1f62-f1f3-4a1c-a35a-219af833c5ab"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("h2",{attrs:{id:"test-eks-access"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#test-eks-access"}},[s._v("#")]),s._v(" Test EKS access")]),s._v(" "),a("p",[s._v("Update the aws-auth ConfigMap to allow our IAM roles:")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("eksctl get iamidentitymapping "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_NAME}")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--arn")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MYUSER1_ROLE_ARN}")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" eksctl create iamidentitymapping "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_NAME}")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--arn")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MYUSER1_ROLE_ARN}")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--username")]),s._v(" myuser1 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--group")]),s._v(" capsule.clastix.io\neksctl get iamidentitymapping "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_NAME}")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--arn")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MYUSER2_ROLE_ARN}")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" eksctl create iamidentitymapping "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_NAME}")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--arn")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MYUSER2_ROLE_ARN}")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--username")]),s._v(" myuser2 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--group")]),s._v(" capsule.clastix.io\neksctl get iamidentitymapping "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_NAME}")]),s._v('"')]),s._v("\n")])])]),a("p",[s._v("Output:")]),s._v(" "),a("div",{staticClass:"language-text extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("ARN            USERNAME    GROUPS     ACCOUNT\narn:aws:iam::7xxxxxxxxxx7:role/eksctl-kube1-cluster-FargatePodExecutionRole-PL4ECOM50EOZ system:node:{{SessionName}}  system:bootstrappers,system:nodes,system:node-proxier\narn:aws:iam::7xxxxxxxxxx7:role/eksctl-kube1-nodegroup-managed-ng-NodeInstanceRole-1NX0EE7ROG5CJ system:node:{{EC2PrivateDNSName}} system:bootstrappers,system:nodes\narn:aws:iam::7xxxxxxxxxx7:role/myuser1-kube1       myuser1     capsule.clastix.io\narn:aws:iam::7xxxxxxxxxx7:role/myuser2-kube1       myuser2     capsule.clastix.io\n")])])]),a("p",[s._v("Create "),a("code",[s._v("config")]),s._v(" and "),a("code",[s._v("credentials")]),s._v(" files and set the environment variables\nfor "),a("code",[s._v("awscli")]),s._v(":")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tmp/'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_FQDN}")]),s._v('/aws_config"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n[profile myuser1]\nrole_arn="),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MYUSER1_ROLE_ARN}")]),s._v("\nsource_profile=myuser1\n\n[profile myuser2]\nrole_arn="),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MYUSER2_ROLE_ARN}")]),s._v("\nsource_profile=myuser2\nEOF")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tmp/'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_FQDN}")]),s._v('/aws_credentials"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n[myuser1]\naws_access_key_id="),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MYUSER1_USER_ACCESSKEYMYUSER}")]),s._v("\naws_secret_access_key="),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MYUSER1_USER_SECRETACCESSKEY}")]),s._v("\n\n[myuser2]\naws_access_key_id="),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MYUSER2_USER_ACCESSKEYMYUSER}")]),s._v("\naws_secret_access_key="),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${MYUSER2_USER_SECRETACCESSKEY}")]),s._v("\nEOF")]),s._v("\n")])])]),a("p",[s._v("Extract "),a("code",[s._v("kubeconfig")]),s._v(" and make it usable for dev profile:")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tmp/'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_FQDN}")]),s._v('/kubeconfig-myuser1.conf"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n  eksctl utils write-kubeconfig "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cluster")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_NAME}")]),s._v('"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tmp/'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_FQDN}")]),s._v('/kubeconfig-myuser1.conf"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tmp/'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_FQDN}")]),s._v('/kubeconfig-myuser1.conf"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tmp/'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_FQDN}")]),s._v('/kubeconfig-myuser2.conf"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tmp/'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_FQDN}")]),s._v('/kubeconfig-myuser1.conf"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n      - name: AWS_PROFILE\n        value: myuser1\n      - name: AWS_CONFIG_FILE\n        value: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${"),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("PWD")]),s._v("}")]),s._v("/tmp/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_FQDN}")]),s._v("/aws_config\n      - name: AWS_SHARED_CREDENTIALS_FILE\n        value: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${"),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("PWD")]),s._v("}")]),s._v("/tmp/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_FQDN}")]),s._v("/aws_credentials\nEOF")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tmp/'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_FQDN}")]),s._v('/kubeconfig-myuser2.conf"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n      - name: AWS_PROFILE\n        value: myuser2\n      - name: AWS_CONFIG_FILE\n        value: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${"),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("PWD")]),s._v("}")]),s._v("/tmp/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_FQDN}")]),s._v("/aws_config\n      - name: AWS_SHARED_CREDENTIALS_FILE\n        value: "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${"),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("PWD")]),s._v("}")]),s._v("/tmp/"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_FQDN}")]),s._v("/aws_credentials\nEOF")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n")])])]),a("p",[s._v("Set the AWS variables and verify the identity:")]),s._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\nexport AWS_CONFIG_FILE="tmp/'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_FQDN}")]),s._v('/aws_config"\nexport AWS_SHARED_CREDENTIALS_FILE="tmp/'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_FQDN}")]),s._v('/aws_credentials"\nexport PATH="/usr/local/bin:\\'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${"),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("PATH")]),s._v("}")]),s._v('"\naws sts get-caller-identity --profile=myuser1 | jq\naws sts get-caller-identity --profile=myuser2 | jq\nEOF')]),s._v("\n")])])]),a("p",[s._v("Output:")]),s._v(" "),a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"UserId"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"AxxxxxxxxxxxxxxxxxxxxE:botocore-session-1638206808"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"Account"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"7xxxxxxxxxx7"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"Arn"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"arn:aws:sts::7xxxxxxxxxx7:assumed-role/myuser1-kube1/botocore-session-1638206808"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"UserId"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"AxxxxxxxxxxxxxxxxxxxxD:botocore-session-1638206812"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"Account"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"7xxxxxxxxxx7"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token property"}},[s._v('"Arn"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"arn:aws:sts::7xxxxxxxxxx7:assumed-role/myuser2-kube1/botocore-session-1638206812"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),a("h2",{attrs:{id:"capsule"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#capsule"}},[s._v("#")]),s._v(" Capsule")]),s._v(" "),a("p",[s._v("Install Capsule\n"),a("a",{attrs:{href:"https://github.com/clastix/capsule/tree/master/charts/capsule",target:"_blank",rel:"noopener noreferrer"}},[s._v("helm chart"),a("OutboundLink")],1),s._v("\nand modify the\n"),a("a",{attrs:{href:"https://github.com/clastix/capsule/blob/master/charts/capsule/values.yaml",target:"_blank",rel:"noopener noreferrer"}},[s._v("default values"),a("OutboundLink")],1),s._v(":")]),s._v(" "),a("blockquote",[a("p",[s._v("Note: Helm Chart for Capsule 0.0.19 doesn't work with Calico yet !")])]),s._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("helm repo "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" --force-update clastix https://clastix.github.io/charts\nhelm upgrade "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--install")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--version")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(".19 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--namespace")]),s._v(" capsule-system --create-namespace "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--wait")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--values")]),s._v(" - capsule clastix/capsule "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\nserviceMonitor:\n  enabled: true\n# Needed for Calico\nmanager:\n  hostNetwork: true\nEOF")]),s._v("\nkubectl "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wait")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--namespace")]),s._v(" capsule-system "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--for")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("condition"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Ready "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--selector")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("app.kubernetes.io/name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("capsule pod\n")])])]),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" - "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\napiVersion: capsule.clastix.io/v1alpha1\nkind: Tenant\nmetadata:\n  name: myuser1\n  namespace: capsule-system\nspec:\n  namespaceQuota: 1\n  owner:\n    kind: User\n    name: myuser1\n  limitRanges:\n    -\n      limits:\n        -\n          max:\n            storage: 10Gi\n          min:\n            storage: 1Gi\n          type: PersistentVolumeClaim\n  storageClasses:\n    allowed:\n      - efs-myuser1-sc\n---\napiVersion: capsule.clastix.io/v1alpha1\nkind: Tenant\nmetadata:\n  name: myuser2\n  namespace: capsule-system\nspec:\n  namespaceQuota: 1\n  owner:\n    kind: User\n    name: myuser2\n  limitRanges:\n    -\n      limits:\n        -\n          max:\n            storage: 10Gi\n          min:\n            storage: 1Gi\n          type: PersistentVolumeClaim\n  storageClasses:\n    allowed:\n      - efs-myuser2-sc\nEOF")]),s._v("\n")])])]),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF2\nset -x\nexport PATH="/usr/local/bin:\\'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${"),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("PATH")]),s._v("}")]),s._v('"\nexport KUBECONFIG="tmp/'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_FQDN}")]),s._v('/kubeconfig-myuser1.conf"\n\nkubectl create namespace myuser1 || true\nkubectl get pods -n myuser1\nkubectl get pods -n default || true\nkubectl get namespace || true\nkubectl get storageclass || true\n\n# This is working fine\nkubectl apply -f - << EOF\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: efs-myuser1-pvc\n  namespace: myuser1\nspec:\n  accessModes:\n    - ReadWriteMany\n  storageClassName: efs-myuser1-sc\n  volumeName: efs-myuser1-pv\n  resources:\n    requests:\n      storage: 1Gi\n---\napiVersion: v1\nkind: Pod\nmetadata:\n  name: myuser1-pod\n  namespace: myuser1\nspec:\n  volumes:\n    - name: efs-myuser1-storage\n      persistentVolumeClaim:\n        claimName: efs-myuser1-pvc\n  containers:\n    - name: myuser1-container\n      image: alpine:3\n      command: ["dd"]\n      args: ["if=/dev/zero", "of=/mnt/myuser1-file", "bs=1M", "count=10"]\n      resources:\n        limits:\n          cpu: "70m"\n          memory: "50Mi"\n        requests:\n          cpu: "50m"\n          memory: "25Mi"\n      volumeMounts:\n        - mountPath: "/mnt"\n          name: efs-myuser1-storage\n  restartPolicy: Never\nEOF\n\n# This will not work because of StorageClass efs-myuser2 can not be used by this tenant\nkubectl apply -f - << EOF || true\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: myuser1-2-efs-pvc\n  namespace: myuser1\nspec:\n  accessModes:\n    - ReadWriteMany\n  storageClassName: efs-myuser2-sc\n  volumeName: efs-myuser2-pv\n  resources:\n    requests:\n      storage: 1Gi\nEOF\nEOF2')]),s._v("\n")])])]),a("p",[s._v("Output:")]),s._v(" "),a("div",{staticClass:"language-text extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('+ export PATH=/usr/local/bin:/usr/gnu/bin:/usr/local/bin:/bin:/usr/bin:.\n+ PATH=/usr/local/bin:/usr/gnu/bin:/usr/local/bin:/bin:/usr/bin:.\n+ export KUBECONFIG=tmp/kube1.k8s.mylabs.dev/kubeconfig-myuser1.conf\n+ KUBECONFIG=tmp/kube1.k8s.mylabs.dev/kubeconfig-myuser1.conf\n+ kubectl create namespace myuser1\nnamespace/myuser1 created\n+ kubectl get pods -n myuser1\nNo resources found in myuser1 namespace.\n+ kubectl get pods -n default\nError from server (Forbidden): pods is forbidden: User "myuser1" cannot list resource "pods" in API group "" in the namespace "default"\n+ true\n+ kubectl get namespace\nError from server (Forbidden): namespaces is forbidden: User "myuser1" cannot list resource "namespaces" in API group "" at the cluster scope\n+ true\n+ kubectl get storageclass\nError from server (Forbidden): storageclasses.storage.k8s.io is forbidden: User "myuser1" cannot list resource "storageclasses" in API group "storage.k8s.io" at the cluster scope\n+ true\n+ kubectl apply -f -\npersistentvolumeclaim/efs-myuser1-pvc created\n+ kubectl apply -f -\nError from server: error when creating "STDIN": admission webhook "pvc.capsule.clastix.io" denied the request: Storage Class efs-myuser2 is forbidden for the current Tenant, one of the following (efs-myuser1)\n+ true\n')])])]),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-i")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF2\nset -x\nexport PATH="/usr/local/bin:\\'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${"),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("PATH")]),s._v("}")]),s._v('"\nexport KUBECONFIG="tmp/'),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CLUSTER_FQDN}")]),s._v('/kubeconfig-myuser2.conf"\n\nkubectl create namespace myuser2 || true\n\nkubectl apply -f - << EOF\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: efs-myuser2-pvc\n  namespace: myuser2\nspec:\n  accessModes:\n    - ReadWriteMany\n  storageClassName: efs-myuser2-sc\n  volumeName: efs-myuser2-pv\n  resources:\n    requests:\n      storage: 1Gi\n---\napiVersion: v1\nkind: Pod\nmetadata:\n  name: myuser2-pod\n  namespace: myuser2\nspec:\n  volumes:\n    - name: efs-myuser2-storage\n      persistentVolumeClaim:\n        claimName: efs-myuser2-pvc\n  containers:\n    - name: myuser2-container\n      image: alpine:3\n      command: ["dd"]\n      args: ["if=/dev/zero", "of=/mnt/myuser2-file", "bs=1M", "count=20"]\n      resources:\n        limits:\n          cpu: "70m"\n          memory: "50Mi"\n        requests:\n          cpu: "50m"\n          memory: "25Mi"\n      volumeMounts:\n        - mountPath: "/mnt"\n          name: efs-myuser2-storage\n  restartPolicy: Never\nEOF\nEOF2')]),s._v("\n")])])])])}),[],!1,null,null,null);a.default=r.exports}}]);