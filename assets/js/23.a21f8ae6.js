(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{311:function(a,s,e){"use strict";e.r(s);var t=e(8),n=Object(t.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"amazon-eks-bottlerocket-and-fargate"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#amazon-eks-bottlerocket-and-fargate"}},[a._v("#")]),a._v(" Amazon EKS Bottlerocket and Fargate")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/cncf/landscape/7f5b02ecba914a32912e77fc78e1c54d1c2f98ec/hosted_logos/amazon-eks.svg?sanitize=true",alt:"Amazon EKS",title:"Amazon EKS"}})]),a._v(" "),s("p",[a._v("Before starting with the main content, it's necessary to provision\nthe "),s("a",{attrs:{href:"https://aws.amazon.com/eks/",target:"_blank",rel:"noopener noreferrer"}},[a._v("Amazon EKS"),s("OutboundLink")],1),a._v(" in AWS.")]),a._v(" "),s("h2",{attrs:{id:"requirements"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#requirements"}},[a._v("#")]),a._v(" Requirements")]),a._v(" "),s("p",[a._v("If you would like to follow this documents and it's task you will need to set up\nfew environment variables.")]),a._v(" "),s("p",[a._v("The "),s("code",[a._v("LETSENCRYPT_ENVIRONMENT")]),a._v(" variable should be one of:")]),a._v(" "),s("ul",[s("li",[s("code",[a._v("staging")]),a._v(" - Let’s Encrypt will create testing certificate (not valid)")]),a._v(" "),s("li",[s("code",[a._v("production")]),a._v(" - Let’s Encrypt will create valid certificate (use with care)")])]),a._v(" "),s("p",[s("code",[a._v("BASE_DOMAIN")]),a._v(" contains DNS records for all your Kubernetes clusters. The cluster\nnames will look like "),s("code",[a._v("CLUSTER_NAME")]),a._v("."),s("code",[a._v("BASE_DOMAIN")]),a._v(" ("),s("code",[a._v("kube1.k8s.mylabs.dev")]),a._v(").")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Hostname / FQDN definitions")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("BASE_DOMAIN")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${BASE_DOMAIN"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":-")]),a._v("k8s.mylabs.dev}")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("CLUSTER_NAME")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${CLUSTER_NAME"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":-")]),a._v("kube1}")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("CLUSTER_FQDN")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${CLUSTER_NAME}")]),a._v("."),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${BASE_DOMAIN}")]),a._v('"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("KUBECONFIG")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${"),s("span",{pre:!0,attrs:{class:"token environment constant"}},[a._v("PWD")]),a._v("}")]),a._v("/kubeconfig-"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${CLUSTER_NAME}")]),a._v(".conf\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v('# * "production" - valid certificates signed by Lets Encrypt ""')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v('# * "staging" - not trusted certs signed by Lets Encrypt "Fake LE Intermediate X1"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("LETSENCRYPT_ENVIRONMENT")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"staging"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("LETSENCRYPT_CERTIFICATE")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"https://letsencrypt.org/certs/staging/letsencrypt-stg-root-x1.pem"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v('# export LETSENCRYPT_ENVIRONMENT="production"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v('# export LETSENCRYPT_CERTIFICATE="https://letsencrypt.org/certs/lets-encrypt-r3.pem"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MY_EMAIL")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"petr.ruzicka@gmail.com"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# GitHub Organization + Team where are the users who will have the admin access")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# to K8s resources (Grafana). Only users in GitHub organization")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# (MY_GITHUB_ORG_NAME) will be able to access the apps via ingress.")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MY_GITHUB_ORG_NAME")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"ruzickap-org"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MY_GITHUB_USERNAME")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"ruzickap"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# AWS Region")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("AWS_DEFAULT_REGION")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"eu-west-1"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("SLACK_CHANNEL")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"mylabs"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Tags used to tag the AWS resources")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("TAGS")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Owner='),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${MY_EMAIL}")]),a._v(' Environment=Dev Group=Cloud_Native Squad=Cloud_Container_Platform compliance:na:defender=bottlerocket"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-e")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${MY_EMAIL}")]),a._v(" | "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${LETSENCRYPT_ENVIRONMENT}")]),a._v(" | "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${CLUSTER_NAME}")]),a._v(" | "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${BASE_DOMAIN}")]),a._v(" | "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${CLUSTER_FQDN}")]),s("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[a._v("\\n")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${TAGS}")]),a._v('"')]),a._v("\n")])])]),s("p",[a._v('Prepare GitHub OAuth "access" credentials ans AWS "access" variables.')]),a._v(" "),s("p",[a._v("You will need to configure AWS CLI: "),s("a",{attrs:{href:"https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("Configuring the AWS CLI"),s("OutboundLink")],1)]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Common password")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MY_PASSWORD")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"xxxx"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# AWS Credentials")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("AWS_ACCESS_KEY_ID")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('""')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("AWS_SECRET_ACCESS_KEY")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('""')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("AWS_CONSOLE_ADMIN_ROLE_ARN")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"arn:aws:iam::7xxxxxxxxxx7:role/xxxxxxxxxxxxxN"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# GitHub Organization OAuth Apps credentials")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MY_GITHUB_ORG_OAUTH_DEX_CLIENT_ID")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"3xxxxxxxxxxxxxxxxxx3"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MY_GITHUB_ORG_OAUTH_DEX_CLIENT_SECRET")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"7xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx8"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_ID")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"4xxxxxxxxxxxxxxxxxx4"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_SECRET")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"7xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxa"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Sysdig credentials")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("SYSDIG_AGENT_ACCESSKEY")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"xxx"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Aqua credentials")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("AQUA_REGISTRY_USERNAME")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"xxx"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("AQUA_REGISTRY_PASSWORD")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"xxx"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("AQUA_ENFORCER_TOKEN")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"xxx"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Splunk credentials")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("SPLUNK_HOST")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"xxx"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("SPLUNK_TOKEN")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"xxx"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("SPLUNK_INDEX_NAME")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"xxx"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Slack incoming webhook")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("SLACK_INCOMING_WEBHOOK_URL")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("SLACK_BOT_API_TOKEN")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"xxxx-xxxxxxxxxxxxx-xxxxxxxxxxxxx-xxxxxxxxxxxxxxxxxxxxxxxP"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Okta configuration")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("OKTA_ISSUER")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"https://exxxxxxx-xxxxx-xx.okta.com"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("OKTA_CLIENT_ID")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"0xxxxxxxxxxxxxxxxxx7"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("OKTA_CLIENT_SECRET")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"1xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxH"')]),a._v("\n")])])]),s("p",[a._v("Verify if all the necessary variables were set:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("case")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${CLUSTER_NAME}")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("in")]),a._v("\nkube1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MY_GITHUB_ORG_OAUTH_DEX_CLIENT_ID")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${MY_GITHUB_ORG_OAUTH_DEX_CLIENT_ID"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":-")]),a._v("${MY_GITHUB_ORG_OAUTH_DEX_CLIENT_ID_KUBE1}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MY_GITHUB_ORG_OAUTH_DEX_CLIENT_SECRET")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${MY_GITHUB_ORG_OAUTH_DEX_CLIENT_SECRET"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":-")]),a._v("${MY_GITHUB_ORG_OAUTH_DEX_CLIENT_SECRET_KUBE1}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_ID")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_ID"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":-")]),a._v("${MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_ID_KUBE1}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_SECRET")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_SECRET"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":-")]),a._v("${MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_SECRET_KUBE1}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\nkube2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MY_GITHUB_ORG_OAUTH_DEX_CLIENT_ID")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${MY_GITHUB_ORG_OAUTH_DEX_CLIENT_ID"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":-")]),a._v("${MY_GITHUB_ORG_OAUTH_DEX_CLIENT_ID_KUBE2}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MY_GITHUB_ORG_OAUTH_DEX_CLIENT_SECRET")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${MY_GITHUB_ORG_OAUTH_DEX_CLIENT_SECRET"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":-")]),a._v("${MY_GITHUB_ORG_OAUTH_DEX_CLIENT_SECRET_KUBE2}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_ID")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_ID"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":-")]),a._v("${MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_ID_KUBE2}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_SECRET")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_SECRET"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":-")]),a._v("${MY_GITHUB_ORG_OAUTH_KEYCLOAK_CLIENT_SECRET_KUBE2}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n*"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Unsupported cluster name: '),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${CLUSTER_NAME}")]),a._v(' !"')]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("exit")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("esac")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS_ACCESS_KEY_ID?}")]),a._v('"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS_SECRET_ACCESS_KEY?}")]),a._v('"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS_CONSOLE_ADMIN_ROLE_ARN?}")]),a._v('"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${GITHUB_TOKEN?}")]),a._v('"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${SLACK_INCOMING_WEBHOOK_URL?}")]),a._v('"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${SLACK_BOT_API_TOKEN?}")]),a._v('"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${MY_PASSWORD?}")]),a._v('"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${OKTA_ISSUER?}")]),a._v('"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${OKTA_CLIENT_ID?}")]),a._v('"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(":")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${OKTA_CLIENT_SECRET?}")]),a._v('"')]),a._v("\n")])])]),s("h2",{attrs:{id:"prepare-the-local-working-environment"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#prepare-the-local-working-environment"}},[a._v("#")]),a._v(" Prepare the local working environment")]),a._v(" "),s("div",{staticClass:"custom-block tip"},[s("p",{staticClass:"custom-block-title"},[a._v("TIP")]),a._v(" "),s("p",[a._v("You can skip these steps if you have all the required software already\ninstalled.")])]),a._v(" "),s("p",[a._v("Install necessary software:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("command")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("apt-get")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&>")]),a._v(" /dev/null"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("apt")]),a._v(" update "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-qq")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("DEBIAN_FRONTEND")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("noninteractive "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("apt-get")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("install")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-y")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-qq")]),a._v(" apache2-utils ansible dnsutils "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("git")]),a._v(" gnupg2 jq "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("unzip")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" /dev/null\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n")])])]),s("p",[a._v("Install "),s("a",{attrs:{href:"https://aws.amazon.com/cli/",target:"_blank",rel:"noopener noreferrer"}},[a._v("AWS CLI"),s("OutboundLink")],1),a._v("  binary:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("command")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" aws "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&>")]),a._v(" /dev/null"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-sL")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-o")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"/tmp/awscliv2.zip"')]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("unzip")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-q")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-o")]),a._v(" /tmp/awscliv2.zip "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" /tmp/\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" /tmp/aws/install\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n")])])]),s("p",[a._v("Install "),s("a",{attrs:{href:"https://github.com/kubernetes/kubectl",target:"_blank",rel:"noopener noreferrer"}},[a._v("kubectl"),s("OutboundLink")],1),a._v(" binary:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("command")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" kubectl "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&>")]),a._v(" /dev/null"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# https://github.com/kubernetes/kubectl/releases")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-s")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-Lo")]),a._v(" /usr/local/bin/kubectl "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"https://storage.googleapis.com/kubernetes-release/release/v1.21.1/bin/'),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("uname")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sed")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"s/./\\L&/g"')]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v('/amd64/kubectl"')]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("chmod")]),a._v(" a+x /usr/local/bin/kubectl\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n")])])]),s("p",[a._v("Install "),s("a",{attrs:{href:"https://helm.sh/",target:"_blank",rel:"noopener noreferrer"}},[a._v("Helm"),s("OutboundLink")],1),a._v(":")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("command")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" helm "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&>")]),a._v(" /dev/null"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# https://github.com/helm/helm/releases")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-s")]),a._v(" https://raw.githubusercontent.com/helm/helm/master/scripts/get "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("bash")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-s")]),a._v(" -- "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--version")]),a._v(" v3.6.0\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n")])])]),s("p",[a._v("Install "),s("a",{attrs:{href:"https://eksctl.io/",target:"_blank",rel:"noopener noreferrer"}},[a._v("eksctl"),s("OutboundLink")],1),a._v(":")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("command")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" eksctl "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&>")]),a._v(" /dev/null"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# https://github.com/weaveworks/eksctl/releases")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-s")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-L")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"https://github.com/weaveworks/eksctl/releases/download/0.60.0/eksctl_'),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("uname")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v('_amd64.tar.gz"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("tar")]),a._v(" xz "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-C")]),a._v(" /usr/local/bin/\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n")])])]),s("p",[a._v("Install "),s("a",{attrs:{href:"https://github.com/kubernetes-sigs/aws-iam-authenticator",target:"_blank",rel:"noopener noreferrer"}},[a._v("AWS IAM Authenticator for Kubernetes"),s("OutboundLink")],1),a._v(":")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("command")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" aws-iam-authenticator "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&>")]),a._v(" /dev/null"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# https://docs.aws.amazon.com/eks/latest/userguide/install-aws-iam-authenticator.html")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-s")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-Lo")]),a._v(" /usr/local/bin/aws-iam-authenticator "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"https://amazon-eks.s3.us-west-2.amazonaws.com/1.19.6/2021-01-05/bin/'),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("uname")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sed")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"s/./\\L&/g"')]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v('/amd64/aws-iam-authenticator"')]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("chmod")]),a._v(" a+x /usr/local/bin/aws-iam-authenticator\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n")])])]),s("p",[a._v("Install "),s("a",{attrs:{href:"https://www.vaultproject.io/downloads",target:"_blank",rel:"noopener noreferrer"}},[a._v("vault"),s("OutboundLink")],1),a._v(":")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("command")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" vault "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&>")]),a._v(" /dev/null"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-s")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-L")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"https://releases.hashicorp.com/vault/1.7.2/vault_1.7.2_'),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("uname")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sed")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"s/./\\L&/g"')]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v('_amd64.zip"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-o")]),a._v(" /tmp/vault.zip\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("unzip")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-q")]),a._v(" /tmp/vault.zip "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" /usr/local/bin/\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("rm")]),a._v(" /tmp/vault.zip\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n")])])]),s("p",[a._v("Install "),s("a",{attrs:{href:"https://github.com/vmware-tanzu/velero/releases",target:"_blank",rel:"noopener noreferrer"}},[a._v("velero"),s("OutboundLink")],1),a._v(":")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("command")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" velero "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&>")]),a._v(" /dev/null"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-s")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-L")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"https://github.com/vmware-tanzu/velero/releases/download/v1.6.0/velero-v1.6.0-'),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("uname")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sed")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"s/./\\L&/g"')]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v('-amd64.tar.gz"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-o")]),a._v(" /tmp/velero.tar.gz\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("tar")]),a._v(" xzf /tmp/velero.tar.gz "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-C")]),a._v(" /usr/local/bin/ --strip-components "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"velero-v1.6.0-'),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("uname")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sed")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"s/./\\L&/g"')]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v('-amd64/velero"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n")])])]),s("p",[a._v("Install "),s("a",{attrs:{href:"https://toolkit.fluxcd.io/",target:"_blank",rel:"noopener noreferrer"}},[a._v("flux"),s("OutboundLink")],1),a._v(":")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("command")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" flux "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&>")]),a._v(" /dev/null"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-s")]),a._v(" https://fluxcd.io/install.sh "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("bash")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n")])])]),s("p",[a._v("Install "),s("code",[a._v("calicoctl")]),a._v(":")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("command")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" calicoctl "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&>")]),a._v(" /dev/null"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-s")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-Lo")]),a._v(" /usr/local/bin/calicoctl https://github.com/projectcalico/calicoctl/releases/download/v3.20.0/calicoctl\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("chmod")]),a._v(" a+x /usr/local/bin/calicoctl\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n")])])]),s("p",[a._v("Install "),s("a",{attrs:{href:"https://github.com/mozilla/sops",target:"_blank",rel:"noopener noreferrer"}},[a._v("SOPS: Secrets OPerationS"),s("OutboundLink")],1),a._v(":")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("command")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" sops "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&>")]),a._v(" /dev/null"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-s")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-Lo")]),a._v(" /usr/local/bin/sops "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"https://github.com/mozilla/sops/releases/download/v3.7.1/sops-v3.7.1.'),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("uname")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sed")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"s/./\\L&/g"')]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v('"')]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("chmod")]),a._v(" a+x /usr/local/bin/sops\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n")])])]),s("p",[a._v("Install "),s("a",{attrs:{href:"https://kustomize.io/",target:"_blank",rel:"noopener noreferrer"}},[a._v("kustomize"),s("OutboundLink")],1),a._v(":")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("command")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" kustomize "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&>")]),a._v(" /dev/null"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-s")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("bash")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-s")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("4.1")]),a._v(".2 /usr/local/bin/\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n")])])]),s("p",[a._v("Install "),s("a",{attrs:{href:"https://github.com/rakyll/hey",target:"_blank",rel:"noopener noreferrer"}},[a._v("hey"),s("OutboundLink")],1),a._v(":")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("command")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-v")]),a._v(" hey "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&>")]),a._v(" /dev/null"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-s")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-Lo")]),a._v(" /usr/local/bin/hey "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"https://hey-release.s3.us-east-2.amazonaws.com/hey_'),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("uname")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sed")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"s/./\\L&/g"')]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v('_amd64"')]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sudo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("chmod")]),a._v(" a+x /usr/local/bin/hey\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n")])])]),s("h2",{attrs:{id:"configure-aws-route-53-domain-delegation"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#configure-aws-route-53-domain-delegation"}},[a._v("#")]),a._v(" Configure AWS Route 53 Domain delegation")]),a._v(" "),s("p",[a._v("Create DNS zone ("),s("code",[a._v("BASE_DOMAIN")]),a._v("):")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[a._v("aws route53 create-hosted-zone "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--output")]),a._v(" json "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${BASE_DOMAIN}")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  --caller-reference "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("date")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  --hosted-zone-config"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"{'),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v("Comment"),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v(": "),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v("Created by "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${MY_EMAIL}")]),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v(", "),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v("PrivateZone"),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v(': false}"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" jq\n")])])]),s("p",[a._v('Use your domain registrar to change the nameservers for your zone (for example\n"mylabs.dev") to use the Amazon Route 53 nameservers. Here is the way how you\ncan find out the the Route 53 nameservers:')]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("NEW_ZONE_ID")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),a._v("aws route53 list-hosted-zones "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--query")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"HostedZones[?Name==\\'),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")]),a._v("$"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("BASE_DOMAIN"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("."),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")])]),a._v('].Id"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--output")]),a._v(" text"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("NEW_ZONE_NS")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),a._v("aws route53 get-hosted-zone "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--output")]),a._v(" json "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--id")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${NEW_ZONE_ID}")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--query")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"DelegationSet.NameServers"')]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("NEW_ZONE_NS1")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${NEW_ZONE_NS}")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" jq "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-r")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('".[0]"')]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("NEW_ZONE_NS2")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${NEW_ZONE_NS}")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" jq "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-r")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('".[1]"')]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n")])])]),s("p",[a._v("Create the NS record in "),s("code",[a._v("k8s.mylabs.dev")]),a._v(" ("),s("code",[a._v("BASE_DOMAIN")]),a._v(") for proper zone\ndelegation. This step depends on your domain registrar - I'm using CloudFlare\nand using Ansible to automate it:")]),a._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[a._v("ansible "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-m")]),a._v(" cloudflare_dns "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-c")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("local")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-i")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"localhost,"')]),a._v(" localhost "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-a")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"zone=mylabs.dev record='),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${BASE_DOMAIN}")]),a._v(" type=NS value="),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${NEW_ZONE_NS1}")]),a._v(" solo=true proxied=no account_email="),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${CLOUDFLARE_EMAIL}")]),a._v(" account_api_token="),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${CLOUDFLARE_API_KEY}")]),a._v('"')]),a._v("\nansible "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-m")]),a._v(" cloudflare_dns "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-c")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("local")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-i")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"localhost,"')]),a._v(" localhost "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-a")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"zone=mylabs.dev record='),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${BASE_DOMAIN}")]),a._v(" type=NS value="),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${NEW_ZONE_NS2}")]),a._v(" solo=false proxied=no account_email="),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${CLOUDFLARE_EMAIL}")]),a._v(" account_api_token="),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${CLOUDFLARE_API_KEY}")]),a._v('"')]),a._v("\n")])])]),s("p",[a._v("Output:")]),a._v(" "),s("div",{staticClass:"language-text extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('localhost | CHANGED => {\n    "ansible_facts": {\n        "discovered_interpreter_python": "/usr/bin/python"\n    },\n    "changed": true,\n    "result": {\n        "record": {\n            "content": "ns-885.awsdns-46.net",\n            "created_on": "2020-11-13T06:25:32.18642Z",\n            "id": "dxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxb",\n            "locked": false,\n            "meta": {\n                "auto_added": false,\n                "managed_by_apps": false,\n                "managed_by_argo_tunnel": false,\n                "source": "primary"\n            },\n            "modified_on": "2020-11-13T06:25:32.18642Z",\n            "name": "k8s.mylabs.dev",\n            "proxiable": false,\n            "proxied": false,\n            "ttl": 1,\n            "type": "NS",\n            "zone_id": "2xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxe",\n            "zone_name": "mylabs.dev"\n        }\n    }\n}\nlocalhost | CHANGED => {\n    "ansible_facts": {\n        "discovered_interpreter_python": "/usr/bin/python"\n    },\n    "changed": true,\n    "result": {\n        "record": {\n            "content": "ns-1692.awsdns-19.co.uk",\n            "created_on": "2020-11-13T06:25:37.605605Z",\n            "id": "9xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxb",\n            "locked": false,\n            "meta": {\n                "auto_added": false,\n                "managed_by_apps": false,\n                "managed_by_argo_tunnel": false,\n                "source": "primary"\n            },\n            "modified_on": "2020-11-13T06:25:37.605605Z",\n            "name": "k8s.mylabs.dev",\n            "proxiable": false,\n            "proxied": false,\n            "ttl": 1,\n            "type": "NS",\n            "zone_id": "2xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxe",\n            "zone_name": "mylabs.dev"\n        }\n    }\n}\n')])])]),s("h2",{attrs:{id:"add-new-domain-to-route-53-policies-s3-ebs"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#add-new-domain-to-route-53-policies-s3-ebs"}},[a._v("#")]),a._v(" Add new domain to Route 53, Policies, S3, EBS")]),a._v(" "),s("p",[a._v("Details with examples are described on these links:")]),a._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://aws.amazon.com/blogs/opensource/introducing-fine-grained-iam-roles-service-accounts/",target:"_blank",rel:"noopener noreferrer"}},[a._v("https://aws.amazon.com/blogs/opensource/introducing-fine-grained-iam-roles-service-accounts/"),s("OutboundLink")],1)]),a._v(" "),s("li",[s("a",{attrs:{href:"https://cert-manager.io/docs/configuration/acme/dns01/route53/",target:"_blank",rel:"noopener noreferrer"}},[a._v("https://cert-manager.io/docs/configuration/acme/dns01/route53/"),s("OutboundLink")],1)]),a._v(" "),s("li",[s("a",{attrs:{href:"https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/aws.md",target:"_blank",rel:"noopener noreferrer"}},[a._v("https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/aws.md"),s("OutboundLink")],1)])]),a._v(" "),s("p",[a._v("Create CloudFormation template containing policies for Route53, S3 access\n(Harbor, Velero) and Domain. Put new domain "),s("code",[a._v("CLUSTER_FQDN")]),a._v(" to the Route 53 and\nconfigure the DNS delegation from the "),s("code",[a._v("BASE_DOMAIN")]),a._v(".")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("mkdir")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-vp")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"tmp/'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${CLUSTER_FQDN}")]),a._v('"')]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("cat")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"tmp/'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${CLUSTER_FQDN}")]),a._v('/aws-route53-iam-s3-kms-asm.yml"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<<")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("EOF\nDescription: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Template to generate the necessary IAM Policies for access to Route53 and S3"')]),a._v("\nParameters:\n  ClusterFQDN:\n    Description: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Cluster domain where all necessary app subdomains will live (subdomain of BaseDomain). Ex: kube1.k8s.mylabs.dev"')]),a._v("\n    Type: String\n  ClusterName:\n    Description: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Cluster Name Ex: kube1"')]),a._v("\n    Type: String\n  BaseDomain:\n    Description: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Base domain where cluster domains + their subdomains will live. Ex: k8s.mylabs.dev"')]),a._v("\n    Type: String\nResources:\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# This AWS control checks whether the status of the AWS Systems Manager association compliance is COMPLIANT or NON_COMPLIANT after the association is executed on an instance.")]),a._v("\n  ConfigRule:\n    Type: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"AWS::Config::ConfigRule"')]),a._v("\n    Properties:\n      ConfigRuleName: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${ClusterName}")]),a._v('-ec2-managedinstance-association-compliance-status-check"')]),a._v("\n      Scope:\n        ComplianceResourceTypes:\n          - "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"AWS::SSM::AssociationCompliance"')]),a._v("\n      Description: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"A Config rule that checks whether the compliance status of the Amazon EC2 Systems Manager association compliance is COMPLIANT or NON_COMPLIANT after the association execution on the instance. The rule is compliant if the field status is COMPLIANT."')]),a._v("\n      Source:\n        Owner: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"AWS"')]),a._v("\n        SourceIdentifier: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"EC2_MANAGEDINSTANCE_ASSOCIATION_COMPLIANCE_STATUS_CHECK"')]),a._v("\n  CloudWatchPolicy:\n    Type: AWS::IAM::ManagedPolicy\n    Properties:\n      ManagedPolicyName: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${ClusterFQDN}")]),a._v('-CloudWatch"')]),a._v("\n      Description: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Policy required by Fargate to log to CloudWatch for '),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${ClusterFQDN}")]),a._v('"')]),a._v("\n      PolicyDocument:\n        Version: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"2012-10-17"')]),a._v("\n        Statement:\n        - Effect: Allow\n          Action:\n          - logs:CreateLogStream\n          - logs:CreateLogGroup\n          - logs:DescribeLogStreams\n          - logs:PutLogEvents\n          Resource: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"*"')]),a._v("\n  HostedZone:\n    Type: AWS::Route53::HostedZone\n    Properties:\n      Name: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Ref ClusterFQDN\n  KMSAlias:\n    Type: AWS::KMS::Alias\n    Properties:\n      AliasName: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"alias/eks-'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${ClusterName}")]),a._v('"')]),a._v("\n      TargetKeyId: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Ref KMSKey\n  KMSKey:\n    Type: AWS::KMS::Key\n    Properties:\n      Description: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"KMS key for secrets related to '),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${ClusterFQDN}")]),a._v('"')]),a._v("\n      EnableKeyRotation: "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),a._v("\n      PendingWindowInDays: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("7")]),a._v("\n      KeyPolicy:\n        Version: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"2012-10-17"')]),a._v("\n        Id: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"eks-key-policy-'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${ClusterName}")]),a._v('"')]),a._v("\n        Statement:\n        - Sid: Enable IAM User Permissions\n          Effect: Allow\n          Principal:\n            AWS: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"arn:aws:iam::'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v("AccountId}")]),a._v(':root"')]),a._v("\n          Action: kms:*\n          Resource: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"*"')]),a._v("\n        - Sid: Allow use of the key\n          Effect: Allow\n          Principal:\n            AWS: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"arn:aws:iam::'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v("AccountId}")]),a._v(':role/aws-service-role/autoscaling.amazonaws.com/AWSServiceRoleForAutoScaling"')]),a._v("\n          Action:\n          - kms:Encrypt\n          - kms:Decrypt\n          - kms:ReEncrypt*\n          - kms:GenerateDataKey*\n          - kms:DescribeKey\n          Resource: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"*"')]),a._v("\n        - Sid: Allow attachment of persistent resources\n          Effect: Allow\n          Principal:\n            AWS: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"arn:aws:iam::'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v("AccountId}")]),a._v(':role/aws-service-role/autoscaling.amazonaws.com/AWSServiceRoleForAutoScaling"')]),a._v("\n          Action:\n          - kms:CreateGrant\n          Resource: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"*"')]),a._v("\n          Condition:\n            Bool:\n              kms:GrantIsForAWSResource: "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),a._v("\n  EKSViewNodesAndWorkloadsPolicy:\n    Type: AWS::IAM::ManagedPolicy\n    Properties:\n      ManagedPolicyName: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${ClusterFQDN}")]),a._v('-EKSViewNodesAndWorkloads"')]),a._v("\n      Description: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Policy used to view workloads running in an EKS cluster created using CAPA"')]),a._v("\n      PolicyDocument:\n        Version: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"2012-10-17"')]),a._v("\n        Statement:\n        - Effect: Allow\n          Action:\n          - eks:DescribeNodegroup\n          - eks:ListNodegroups\n          - eks:DescribeCluster\n          - eks:ListClusters\n          - eks:AccessKubernetesApi\n          - ssm:GetParameter\n          - eks:ListUpdates\n          - eks:ListFargateProfiles\n          Resource: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"*"')]),a._v("\n  RecordSet:\n    Type: AWS::Route53::RecordSet\n    Properties:\n      HostedZoneName: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${BaseDomain}")]),a._v('."')]),a._v("\n      Name: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Ref ClusterFQDN\n      Type: NS\n      TTL: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("60")]),a._v("\n      ResourceRecords: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("GetAtt HostedZone.NameServers\n  S3Policy:\n    Type: AWS::IAM::ManagedPolicy\n    Properties:\n      ManagedPolicyName: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${ClusterFQDN}")]),a._v('-AmazonS3"')]),a._v("\n      Description: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Policy required by Harbor and Velero to write to S3 bucket '),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${ClusterFQDN}")]),a._v('"')]),a._v("\n      PolicyDocument:\n        Version: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"2012-10-17"')]),a._v("\n        Statement:\n        - Effect: Allow\n          Action:\n          - s3:ListBucket\n          - s3:GetBucketLocation\n          - s3:ListBucketMultipartUploads\n          Resource: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("GetAtt S3Bucket.Arn\n        - Effect: Allow\n          Action:\n          - s3:PutObject\n          - s3:GetObject\n          - s3:DeleteObject\n          - s3:ListMultipartUploadParts\n          - s3:AbortMultipartUpload\n          Resource: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"arn:aws:s3:::'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${ClusterFQDN}")]),a._v('/*"')]),a._v("\n  S3Bucket:\n    Type: AWS::S3::Bucket\n    Properties:\n      AccessControl: Private\n      BucketName: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${ClusterFQDN}")]),a._v('"')]),a._v("\n      BucketEncryption:\n        ServerSideEncryptionConfiguration:\n          - ServerSideEncryptionByDefault:\n              SSEAlgorithm: AES256\n  SecretsManagerMySecret:\n    Type: AWS::SecretsManager::Secret\n    Properties:\n      Name: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${ClusterFQDN}")]),a._v('-MySecret"')]),a._v("\n      Description: My Secret\n      GenerateSecretString:\n        SecretStringTemplate: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"{'),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v("username"),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v(": "),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v("Administrator"),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v('}"')]),a._v("\n        GenerateStringKey: password\n        PasswordLength: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("32")]),a._v("\n      KmsKeyId: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Ref KMSKey\n  SecretsManagerMySecret2:\n    Type: AWS::SecretsManager::Secret\n    Properties:\n      Name: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${ClusterFQDN}")]),a._v('-MySecret2"')]),a._v("\n      Description: My Secret2\n      GenerateSecretString:\n        SecretStringTemplate: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"{'),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v("username"),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v(": "),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v("Administrator2"),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v('}"')]),a._v("\n        GenerateStringKey: password\n        PasswordLength: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("32")]),a._v("\n      KmsKeyId: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Ref KMSKey\n  UserMyUser1:\n    Type: AWS::IAM::User\n    Properties:\n      UserName: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"myuser1-'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${ClusterName}")]),a._v('"')]),a._v("\n      Policies:\n      - PolicyName: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"myuser1-'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${ClusterName}")]),a._v('-policy"')]),a._v("\n        PolicyDocument:\n          Version: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"2012-10-17"')]),a._v("\n          Statement:\n          - Sid: AllowAssumeOrganizationAccountRole\n            Effect: Allow\n            Action: sts:AssumeRole\n            Resource: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("GetAtt RoleMyUser1.Arn\n  AccessKeyMyUser1:\n    Type: AWS::IAM::AccessKey\n    Properties:\n      UserName: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Ref UserMyUser1\n  RoleMyUser1:\n    Type: AWS::IAM::Role\n    Properties:\n      Description: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"IAM role for the myuser1-'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${ClusterName}")]),a._v(' user"')]),a._v("\n      RoleName: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"myuser1-'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${ClusterName}")]),a._v('"')]),a._v("\n      AssumeRolePolicyDocument:\n        Version: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2012")]),a._v("-10-17\n        Statement:\n        - Effect: Allow\n          Principal:\n            AWS: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"arn:aws:iam::'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v("AccountId}")]),a._v(':root"')]),a._v("\n          Action: sts:AssumeRole\n  UserMyUser2:\n    Type: AWS::IAM::User\n    Properties:\n      UserName: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"myuser2-'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${ClusterName}")]),a._v('"')]),a._v("\n      Policies:\n      - PolicyName: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"myuser2-'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${ClusterName}")]),a._v('-policy"')]),a._v("\n        PolicyDocument:\n          Version: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"2012-10-17"')]),a._v("\n          Statement:\n          - Sid: AllowAssumeOrganizationAccountRole\n            Effect: Allow\n            Action: sts:AssumeRole\n            Resource: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("GetAtt RoleMyUser2.Arn\n  AccessKeyMyUser2:\n    Type: AWS::IAM::AccessKey\n    Properties:\n      UserName: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Ref UserMyUser2\n  RoleMyUser2:\n    Type: AWS::IAM::Role\n    Properties:\n      Description: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"IAM role for the myuser2-'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${ClusterName}")]),a._v(' user"')]),a._v("\n      RoleName: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"myuser2-'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${ClusterName}")]),a._v('"')]),a._v("\n      AssumeRolePolicyDocument:\n        Version: "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2012")]),a._v("-10-17\n        Statement:\n        - Effect: Allow\n          Principal:\n            AWS: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Sub "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"arn:aws:iam::'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v("AccountId}")]),a._v(':root"')]),a._v("\n          Action: sts:AssumeRole\nOutputs:\n  CloudWatchPolicyArn:\n    Description: The ARN of the created CloudWatchPolicy\n    Value: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Ref CloudWatchPolicy\n    Export:\n      Name:\n        Fn::Sub: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v("StackName}")]),a._v('-CloudWatchPolicyArn"')]),a._v("\n  KMSKeyArn:\n    Description: The ARN of the created KMS Key to encrypt EKS related services\n    Value: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("GetAtt KMSKey.Arn\n    Export:\n      Name:\n        Fn::Sub: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v("StackName}")]),a._v('-KMSKeyArn"')]),a._v("\n  KMSKeyId:\n    Description: The ID of the created KMS Key to encrypt EKS related services\n    Value: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Ref KMSKey\n    Export:\n      Name:\n        Fn::Sub: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v("StackName}")]),a._v('-KMSKeyId"')]),a._v("\n  HostedZoneArn:\n    Description: The ARN of the created Route53 Zone "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("for")]),a._v(" K8s cluster\n    Value: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Ref HostedZone\n    Export:\n      Name:\n        Fn::Sub: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v("StackName}")]),a._v('-HostedZoneArn"')]),a._v("\n  S3PolicyArn:\n    Description: The ARN of the created AmazonS3 policy\n    Value: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Ref S3Policy\n    Export:\n      Name:\n        Fn::Sub: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v("StackName}")]),a._v('-S3PolicyArn"')]),a._v("\n  RoleMyUser1Arn:\n    Description: The ARN of the MyUser1 IAM Role\n    Value: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("GetAtt RoleMyUser1.Arn\n    Export:\n      Name:\n        Fn::Sub: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v("StackName}")]),a._v('-RoleMyUser1Arn"')]),a._v("\n  AccessKeyMyUser1:\n    Description: The AccessKey "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("for")]),a._v(" MyUser1 user\n    Value: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Ref AccessKeyMyUser1\n    Export:\n      Name:\n        Fn::Sub: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v("StackName}")]),a._v('-AccessKeyMyUser1"')]),a._v("\n  SecretAccessKeyMyUser1:\n    Description: The SecretAccessKey "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("for")]),a._v(" MyUser1 user\n    Value: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("GetAtt AccessKeyMyUser1.SecretAccessKey\n    Export:\n      Name:\n        Fn::Sub: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v("StackName}")]),a._v('-SecretAccessKeyMyUser1"')]),a._v("\n  RoleMyUser2Arn:\n    Description: The ARN of the MyUser2 IAM Role\n    Value: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("GetAtt RoleMyUser2.Arn\n    Export:\n      Name:\n        Fn::Sub: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v("StackName}")]),a._v('-RoleMyUser2Arn"')]),a._v("\n  AccessKeyMyUser2:\n    Description: The AccessKey "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("for")]),a._v(" MyUser2 user\n    Value: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("Ref AccessKeyMyUser2\n    Export:\n      Name:\n        Fn::Sub: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v("StackName}")]),a._v('-AccessKeyMyUser2"')]),a._v("\n  SecretAccessKeyMyUser2:\n    Description: The SecretAccessKey "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("for")]),a._v(" MyUser2 user\n    Value: "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v("GetAtt AccessKeyMyUser2.SecretAccessKey\n    Export:\n      Name:\n        Fn::Sub: "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v("StackName}")]),a._v('-SecretAccessKeyMyUser2"')]),a._v("\nEOF\n\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("eval")]),a._v(" aws cloudformation deploy "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--capabilities")]),a._v(" CAPABILITY_NAMED_IAM "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  --parameter-overrides "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"ClusterFQDN='),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${CLUSTER_FQDN}")]),a._v(" ClusterName="),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${CLUSTER_NAME}")]),a._v(" BaseDomain="),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${BASE_DOMAIN}")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),a._v("\n  --stack-name "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${CLUSTER_NAME}")]),a._v('-route53-iam-s3-kms-asm"')]),a._v(" --template-file "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"tmp/'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${CLUSTER_FQDN}")]),a._v('/aws-route53-iam-s3-kms-asm.yml"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--tags")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${TAGS}")]),a._v('"')]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("AWS_CLOUDFORMATION_DETAILS")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),a._v("aws cloudformation describe-stacks --stack-name "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${CLUSTER_NAME}")]),a._v('-route53-iam-s3-kms-asm"')]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("CLOUDWATCH_POLICY_ARN")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS_CLOUDFORMATION_DETAILS}")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" jq "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-r")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('".Stacks[0].Outputs[] | select(.OutputKey=='),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v("CloudWatchPolicyArn"),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v(') .OutputValue"')]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("KMS_KEY_ARN")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS_CLOUDFORMATION_DETAILS}")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" jq "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-r")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('".Stacks[0].Outputs[] | select(.OutputKey=='),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v("KMSKeyArn"),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v(') .OutputValue"')]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("KMS_KEY_ID")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS_CLOUDFORMATION_DETAILS}")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" jq "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-r")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('".Stacks[0].Outputs[] | select(.OutputKey=='),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v("KMSKeyId"),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v(') .OutputValue"')]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("S3_POLICY_ARN")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS_CLOUDFORMATION_DETAILS}")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" jq "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-r")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('".Stacks[0].Outputs[] | select(.OutputKey=='),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v("S3PolicyArn"),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v(') .OutputValue"')]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MYUSER1_ROLE_ARN")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS_CLOUDFORMATION_DETAILS}")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" jq "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-r")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('".Stacks[0].Outputs[] | select(.OutputKey=='),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v("RoleMyUser1Arn"),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v(') .OutputValue"')]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MYUSER1_USER_ACCESSKEYMYUSER")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS_CLOUDFORMATION_DETAILS}")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" jq "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-r")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('".Stacks[0].Outputs[] | select(.OutputKey=='),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v("AccessKeyMyUser1"),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v(') .OutputValue"')]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MYUSER1_USER_SECRETACCESSKEY")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS_CLOUDFORMATION_DETAILS}")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" jq "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-r")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('".Stacks[0].Outputs[] | select(.OutputKey=='),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v("SecretAccessKeyMyUser1"),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v(') .OutputValue"')]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MYUSER2_ROLE_ARN")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS_CLOUDFORMATION_DETAILS}")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" jq "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-r")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('".Stacks[0].Outputs[] | select(.OutputKey=='),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v("RoleMyUser2Arn"),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v(') .OutputValue"')]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MYUSER2_USER_ACCESSKEYMYUSER")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS_CLOUDFORMATION_DETAILS}")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" jq "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-r")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('".Stacks[0].Outputs[] | select(.OutputKey=='),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v("AccessKeyMyUser2"),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v(') .OutputValue"')]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("MYUSER2_USER_SECRETACCESSKEY")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS_CLOUDFORMATION_DETAILS}")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" jq "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-r")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('".Stacks[0].Outputs[] | select(.OutputKey=='),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v("SecretAccessKeyMyUser2"),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v(') .OutputValue"')]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n")])])]),s("p",[a._v("Change TTL=60 of SOA + NS records for new domain\n(it can not be done in CloudFormation):")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("HOSTED_ZONE_ID")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),a._v("aws route53 list-hosted-zones "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--query")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"HostedZones[?Name==\\'),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")]),a._v("$"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("CLUSTER_FQDN"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("."),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")])]),a._v('].Id"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--output")]),a._v(" text"),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("RESOURCE_RECORD_SET_SOA")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),a._v("aws route53 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--output")]),a._v(" json list-resource-record-sets --hosted-zone-id "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${HOSTED_ZONE_ID}")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--query")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"(ResourceRecordSets[?Type == \\'),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")]),a._v("SOA"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")])]),a._v('])[0]"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sed")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"s/'),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v("TTL"),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v(":.*/"),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v("TTL"),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v(': 60,/"')]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("RESOURCE_RECORD_SET_NS")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),a._v("aws route53 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--output")]),a._v(" json list-resource-record-sets --hosted-zone-id "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${HOSTED_ZONE_ID}")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--query")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"(ResourceRecordSets[?Type == \\'),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")]),a._v("NS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("\\")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("`")])]),a._v('])[0]"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sed")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"s/'),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v("TTL"),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v(":.*/"),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v("TTL"),s("span",{pre:!0,attrs:{class:"token entity",title:'\\"'}},[a._v('\\"')]),a._v(': 60,/"')]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("cat")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<<")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("EOF"),s("span",{pre:!0,attrs:{class:"token bash punctuation"}},[a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" aws route53 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--output")]),a._v(" json change-resource-record-sets --hosted-zone-id "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${HOSTED_ZONE_ID}")]),a._v('"')]),a._v(" --change-batch"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("file:///dev/stdin")]),a._v('\n{\n    "Comment": "Update record to reflect new TTL for SOA and NS records",\n    "Changes": [\n        {\n            "Action": "UPSERT",\n            "ResourceRecordSet":\n'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${RESOURCE_RECORD_SET_SOA}")]),a._v('\n        },\n        {\n            "Action": "UPSERT",\n            "ResourceRecordSet":\n'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${RESOURCE_RECORD_SET_NS}")]),a._v("\n        }\n    ]\n}\nEOF")]),a._v("\n")])])]),s("h2",{attrs:{id:"create-amazon-eks"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#create-amazon-eks"}},[a._v("#")]),a._v(" Create Amazon EKS")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/aws-samples/eks-workshop/65b766c494a5b4f5420b2912d8373c4957163541/static/images/3-service-animated.gif",alt:"EKS",title:"EKS"}})]),a._v(" "),s("p",[a._v("Create "),s("a",{attrs:{href:"https://aws.amazon.com/eks/",target:"_blank",rel:"noopener noreferrer"}},[a._v("Amazon EKS"),s("OutboundLink")],1),a._v(" in AWS by using "),s("a",{attrs:{href:"https://eksctl.io/",target:"_blank",rel:"noopener noreferrer"}},[a._v("eksctl"),s("OutboundLink")],1),a._v(".\nIt's a tool from Weaveworks based on official\nAWS CloudFormation templates which will be used to launch and configure our\nEKS cluster and nodes.")]),a._v(" "),s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/weaveworks/eksctl/c365149fc1a0b8d357139cbd6cda5aee8841c16c/logo/eksctl.png",alt:"eksctl",title:"eksctl"}})]),a._v(" "),s("p",[a._v("Generate SSH key if not exists:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("test")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-f")]),a._v(" ~/.ssh/id_rsa.pub "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("||")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("install "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-m")]),a._v(" 0700 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-d")]),a._v(" ~/.ssh "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&&")]),a._v(" ssh-keygen "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-b")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2048")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" rsa "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-f")]),a._v(" ~/.ssh/id_rsa "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-q")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-N")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('""')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n")])])]),s("p",[a._v("Create the Amazon EKS cluster with Calico using "),s("code",[a._v("eksctl")]),a._v(":")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("cat")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"tmp/'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${CLUSTER_FQDN}")]),a._v('/eksctl.yaml"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<<")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("EOF\napiVersion: eksctl.io/v1alpha5\nkind: ClusterConfig\nmetadata:\n  name: "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${CLUSTER_NAME}")]),a._v("\n  region: "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS_DEFAULT_REGION}")]),a._v('\n  version: "1.21"\n  tags: &tags\n'),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("$(")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("echo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${TAGS}")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sed")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"s/ /'),s("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[a._v("\\\\")]),a._v('n    /g; s/^/    /g; s/=/: /g"')]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v(")")])]),a._v("\navailabilityZones:\n  - "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS_DEFAULT_REGION}")]),a._v("a\n  - "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS_DEFAULT_REGION}")]),a._v("b\niam:\n  withOIDC: true\n  serviceAccounts:\n    - metadata:\n        name: aws-load-balancer-controller\n        namespace: kube-system\n      wellKnownPolicies:\n        awsLoadBalancerController: true\n    - metadata:\n        name: cert-manager\n        namespace: cert-manager\n      wellKnownPolicies:\n        certManager: true\n    - metadata:\n        name: cluster-autoscaler\n        namespace: kube-system\n      wellKnownPolicies:\n        autoScaler: true\n    - metadata:\n        name: external-dns\n        namespace: external-dns\n      wellKnownPolicies:\n        externalDNS: true\n    - metadata:\n        name: ebs-csi-controller-sa\n        namespace: kube-system\n      wellKnownPolicies:\n        ebsCSIController: true\n    - metadata:\n        name: harbor\n        namespace: harbor\n      attachPolicyARNs:\n        - "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${S3_POLICY_ARN}")]),a._v("\n    - metadata:\n        name: velero\n        namespace: velero\n      attachPolicyARNs:\n        - "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${S3_POLICY_ARN}")]),a._v("\n    - metadata:\n        name: s3-test\n        namespace: s3-test\n      attachPolicyARNs:\n        - "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${S3_POLICY_ARN}")]),a._v('\n    - metadata:\n        name: grafana\n        namespace: kube-prometheus-stack\n      attachPolicyARNs:\n        - arn:aws:iam::aws:policy/AmazonPrometheusQueryAccess\n        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess\n      attachPolicy:\n        Version: 2012-10-17\n        Statement:\n        - Sid: AllowReadingTagsInstancesRegionsFromEC2\n          Effect: Allow\n          Action:\n          - ec2:DescribeTags\n          - ec2:DescribeInstances\n          - ec2:DescribeRegions\n          Resource: "*"\n        - Sid: AllowReadingResourcesForTags\n          Effect: Allow\n          Action: tag:GetResources\n          Resource: "*"\n    - metadata:\n        name: kube-prometheus-stack-prometheus\n        namespace: kube-prometheus-stack\n      attachPolicyARNs:\n        - arn:aws:iam::aws:policy/AmazonPrometheusQueryAccess\n        - arn:aws:iam::aws:policy/AmazonPrometheusRemoteWriteAccess\n    - metadata:\n        name: efs-csi-controller-sa\n        namespace: kube-system\n      wellKnownPolicies:\n        efsCSIController: true\n    - metadata:\n        name: vault\n        namespace: vault\n      attachPolicy:\n        Version: 2012-10-17\n        Statement:\n        - Sid: VaultKMSUnseal\n          Effect: Allow\n          Action:\n          - kms:Encrypt\n          - kms:Decrypt\n          - kms:DescribeKey\n          Resource:\n          - "'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${KMS_KEY_ARN}")]),a._v('"\n    - metadata:\n        name: kuard\n        namespace: kuard\n      attachPolicy:\n        Version: 2012-10-17\n        Statement:\n        - Sid: AllowSecretManagerAccess\n          Effect: Allow\n          Action:\n          - secretsmanager:GetSecretValue\n          - secretsmanager:DescribeSecret\n          Resource:\n          - "arn:aws:secretsmanager:*:*:secret:*"\n        - Sid: AllowKMSAccess\n          Effect: Allow\n          Action:\n          - kms:Decrypt\n          Resource:\n          - "'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${KMS_KEY_ARN}")]),a._v('"\nvpc:\n  nat:\n    gateway: Disable\nmanagedNodeGroups:\n  - name: managed-ng-1\n    amiFamily: Bottlerocket\n    instanceType: t3.xlarge\n    instancePrefix: ruzickap\n    desiredCapacity: 3\n    minSize: 2\n    maxSize: 5\n    volumeSize: 30\n    labels:\n      role: worker\n    tags: *tags\n    iam:\n      withAddonPolicies:\n        autoScaler: true\n        cloudWatch: true\n        ebs: true\n        efs: true\n    maxPodsPerNode: 1000\n    volumeEncrypted: true\n    volumeKmsKeyID: '),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${KMS_KEY_ID}")]),a._v("\nfargateProfiles:\n  - name: fp-fgtest\n    selectors:\n      - namespace: fgtest\n    tags: *tags\nsecretsEncryption:\n  keyARN: "),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${KMS_KEY_ARN}")]),a._v("\ncloudWatch:\n  clusterLogging:\n    enableTypes:\n      - authenticator\nEOF")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v(" eksctl get clusters "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--name")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${CLUSTER_NAME}")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("&>")]),a._v(" /dev/null"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n  eksctl create cluster --config-file "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"tmp/'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${CLUSTER_FQDN}")]),a._v('/eksctl.yaml"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--kubeconfig")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${KUBECONFIG}")]),a._v('"')]),a._v(" --without-nodegroup\n  kubectl delete daemonset "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-n")]),a._v(" kube-system aws-node\n  kubectl apply "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-f")]),a._v(" https://docs.projectcalico.org/archive/v3.20/manifests/calico-vxlan.yaml\n  eksctl create nodegroup --config-file "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"tmp/'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${CLUSTER_FQDN}")]),a._v('/eksctl.yaml"')]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n")])])]),s("p",[a._v("Output:")]),a._v(" "),s("div",{staticClass:"language-text extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('2021-11-29 17:52:50 [ℹ]  eksctl version 0.75.0\n2021-11-29 17:52:50 [ℹ]  using region eu-west-1\n2021-11-29 17:52:50 [ℹ]  subnets for eu-west-1a - public:192.168.0.0/19 private:192.168.64.0/19\n2021-11-29 17:52:50 [ℹ]  subnets for eu-west-1b - public:192.168.32.0/19 private:192.168.96.0/19\n2021-11-29 17:52:50 [ℹ]  using Kubernetes version 1.21\n2021-11-29 17:52:50 [ℹ]  creating EKS cluster "kube1" in "eu-west-1" region with Fargate profile\n2021-11-29 17:52:50 [ℹ]  will create a CloudFormation stack for cluster itself and 0 nodegroup stack(s)\n2021-11-29 17:52:50 [ℹ]  will create a CloudFormation stack for cluster itself and 0 managed nodegroup stack(s)\n2021-11-29 17:52:50 [ℹ]  if you encounter any issues, check CloudFormation console or try \'eksctl utils describe-stacks --region=eu-west-1 --cluster=kube1\'\n2021-11-29 17:52:50 [ℹ]  Kubernetes API endpoint access will use default of {publicAccess=true, privateAccess=false} for cluster "kube1" in "eu-west-1"\n2021-11-29 17:52:50 [ℹ]\n2 sequential tasks: { create cluster control plane "kube1",\n    7 sequential sub-tasks: {\n        wait for control plane to become ready,\n        tag cluster,\n        update CloudWatch logging configuration,\n        create fargate profiles,\n        associate IAM OIDC provider,\n        14 parallel sub-tasks: {\n            2 sequential sub-tasks: {\n                create IAM role for serviceaccount "kube-system/aws-load-balancer-controller",\n                create serviceaccount "kube-system/aws-load-balancer-controller",\n            },\n            2 sequential sub-tasks: {\n                create IAM role for serviceaccount "cert-manager/cert-manager",\n                create serviceaccount "cert-manager/cert-manager",\n            },\n            2 sequential sub-tasks: {\n                create IAM role for serviceaccount "kube-system/cluster-autoscaler",\n                create serviceaccount "kube-system/cluster-autoscaler",\n            },\n            2 sequential sub-tasks: {\n                create IAM role for serviceaccount "external-dns/external-dns",\n                create serviceaccount "external-dns/external-dns",\n            },\n            2 sequential sub-tasks: {\n                create IAM role for serviceaccount "kube-system/ebs-csi-controller-sa",\n                create serviceaccount "kube-system/ebs-csi-controller-sa",\n            },\n            2 sequential sub-tasks: {\n                create IAM role for serviceaccount "harbor/harbor",\n                create serviceaccount "harbor/harbor",\n            },\n            2 sequential sub-tasks: {\n                create IAM role for serviceaccount "velero/velero",\n                create serviceaccount "velero/velero",\n            },\n            2 sequential sub-tasks: {\n                create IAM role for serviceaccount "s3-test/s3-test",\n                create serviceaccount "s3-test/s3-test",\n            },\n            2 sequential sub-tasks: {\n                create IAM role for serviceaccount "kube-prometheus-stack/grafana",\n                create serviceaccount "kube-prometheus-stack/grafana",\n            },\n            2 sequential sub-tasks: {\n                create IAM role for serviceaccount "kube-prometheus-stack/kube-prometheus-stack-prometheus",\n                create serviceaccount "kube-prometheus-stack/kube-prometheus-stack-prometheus",\n            },\n            2 sequential sub-tasks: {\n                create IAM role for serviceaccount "kube-system/efs-csi-controller-sa",\n                create serviceaccount "kube-system/efs-csi-controller-sa",\n            },\n            2 sequential sub-tasks: {\n                create IAM role for serviceaccount "vault/vault",\n                create serviceaccount "vault/vault",\n            },\n            2 sequential sub-tasks: {\n                create IAM role for serviceaccount "kuard/kuard",\n                create serviceaccount "kuard/kuard",\n            },\n            2 sequential sub-tasks: {\n                create IAM role for serviceaccount "kube-system/aws-node",\n                create serviceaccount "kube-system/aws-node",\n            },\n        },\n        restart daemonset "kube-system/aws-node",\n    }\n}\n2021-11-29 17:52:50 [ℹ]  building cluster stack "eksctl-kube1-cluster"\n2021-11-29 17:52:50 [ℹ]  deploying stack "eksctl-kube1-cluster"\n2021-11-29 17:53:21 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-cluster"\n...\n2021-11-29 18:05:55 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-cluster"\n2021-11-29 18:07:59 [✔]  tagged EKS cluster (Owner=petr.ruzicka@gmail.com, Squad=Cloud_Container_Platform, compliance:na:defender=bottlerocket, Environment=Dev, Group=Cloud_Native)\n2021-11-29 18:08:00 [ℹ]  waiting for requested "LoggingUpdate" in cluster "kube1" to succeed\n...\n2021-11-29 18:08:53 [ℹ]  waiting for requested "LoggingUpdate" in cluster "kube1" to succeed\n2021-11-29 18:08:54 [✔]  configured CloudWatch logging for cluster "kube1" in "eu-west-1" (enabled types: authenticator &amp; disabled types: api, audit, controllerManager, scheduler)\n2021-11-29 18:08:54 [ℹ]  creating Fargate profile "fp-fgtest" on EKS cluster "kube1"\n2021-11-29 18:13:12 [ℹ]  created Fargate profile "fp-fgtest" on EKS cluster "kube1"\n2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"\n2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-grafana"\n2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-velero-velero"\n2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-kube-system-efs-csi-controller-sa"\n2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-kuard-kuard"\n2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-cert-manager-cert-manager"\n2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-node"\n2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa"\n2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-kube-system-cluster-autoscaler"\n2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-kube-prometheus-stack-prometheus"\n2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-external-dns-external-dns"\n2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-s3-test-s3-test"\n2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-vault-vault"\n2021-11-29 18:17:44 [ℹ]  building iamserviceaccount stack "eksctl-kube1-addon-iamserviceaccount-harbor-harbor"\n2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-kube-system-cluster-autoscaler"\n2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-cluster-autoscaler"\n2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-harbor-harbor"\n2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-harbor-harbor"\n2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-grafana"\n2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-grafana"\n2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-s3-test-s3-test"\n2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-s3-test-s3-test"\n2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-cert-manager-cert-manager"\n2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-cert-manager-cert-manager"\n2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-kube-system-efs-csi-controller-sa"\n2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-vault-vault"\n2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-efs-csi-controller-sa"\n2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-vault-vault"\n2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-velero-velero"\n2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-velero-velero"\n2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-kuard-kuard"\n2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kuard-kuard"\n2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-external-dns-external-dns"\n2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-external-dns-external-dns"\n2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-kube-prometheus-stack-prometheus"\n2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-kube-prometheus-stack-prometheus"\n2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-node"\n2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-node"\n2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"\n2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"\n2021-11-29 18:17:45 [ℹ]  deploying stack "eksctl-kube1-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa"\n2021-11-29 18:17:45 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa"\n2021-11-29 18:18:00 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-cluster-autoscaler"\n2021-11-29 18:18:00 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-grafana"\n2021-11-29 18:18:01 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-velero-velero"\n2021-11-29 18:18:02 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"\n2021-11-29 18:18:02 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-harbor-harbor"\n2021-11-29 18:18:02 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-s3-test-s3-test"\n2021-11-29 18:18:02 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa"\n2021-11-29 18:18:03 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-cert-manager-cert-manager"\n2021-11-29 18:18:03 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-vault-vault"\n2021-11-29 18:18:03 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kuard-kuard"\n2021-11-29 18:18:04 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-efs-csi-controller-sa"\n2021-11-29 18:18:04 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-node"\n2021-11-29 18:18:04 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-kube-prometheus-stack-prometheus"\n2021-11-29 18:18:05 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-external-dns-external-dns"\n2021-11-29 18:18:17 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-harbor-harbor"\n2021-11-29 18:18:18 [ℹ]  created namespace "harbor"\n2021-11-29 18:18:18 [ℹ]  created serviceaccount "harbor/harbor"\n2021-11-29 18:18:18 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-s3-test-s3-test"\n2021-11-29 18:18:18 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-cluster-autoscaler"\n2021-11-29 18:18:18 [ℹ]  created namespace "s3-test"\n2021-11-29 18:18:18 [ℹ]  created serviceaccount "s3-test/s3-test"\n2021-11-29 18:18:19 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-velero-velero"\n2021-11-29 18:18:19 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-cert-manager-cert-manager"\n2021-11-29 18:18:19 [ℹ]  created namespace "velero"\n2021-11-29 18:18:19 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"\n2021-11-29 18:18:20 [ℹ]  created serviceaccount "velero/velero"\n2021-11-29 18:18:20 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-vault-vault"\n2021-11-29 18:18:20 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-grafana"\n2021-11-29 18:18:21 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-kube-prometheus-stack-prometheus"\n2021-11-29 18:18:21 [ℹ]  created namespace "kube-prometheus-stack"\n2021-11-29 18:18:21 [ℹ]  created serviceaccount "kube-prometheus-stack/kube-prometheus-stack-prometheus"\n2021-11-29 18:18:21 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa"\n2021-11-29 18:18:21 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kuard-kuard"\n2021-11-29 18:18:24 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-efs-csi-controller-sa"\n2021-11-29 18:18:24 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-external-dns-external-dns"\n2021-11-29 18:18:24 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-node"\n2021-11-29 18:18:24 [ℹ]  serviceaccount "kube-system/aws-node" already exists\n2021-11-29 18:18:24 [ℹ]  updated serviceaccount "kube-system/aws-node"\n2021-11-29 18:18:35 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-cluster-autoscaler"\n2021-11-29 18:18:36 [ℹ]  created serviceaccount "kube-system/cluster-autoscaler"\n2021-11-29 18:18:37 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-prometheus-stack-grafana"\n2021-11-29 18:18:38 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kuard-kuard"\n2021-11-29 18:18:38 [ℹ]  created serviceaccount "kube-prometheus-stack/grafana"\n2021-11-29 18:18:38 [ℹ]  created namespace "kuard"\n2021-11-29 18:18:38 [ℹ]  created serviceaccount "kuard/kuard"\n2021-11-29 18:18:38 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-vault-vault"\n2021-11-29 18:18:38 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-cert-manager-cert-manager"\n2021-11-29 18:18:38 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-aws-load-balancer-controller"\n2021-11-29 18:18:38 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa"\n2021-11-29 18:18:38 [ℹ]  created namespace "vault"\n2021-11-29 18:18:39 [ℹ]  created serviceaccount "vault/vault"\n2021-11-29 18:18:39 [ℹ]  created namespace "cert-manager"\n2021-11-29 18:18:39 [ℹ]  created serviceaccount "cert-manager/cert-manager"\n2021-11-29 18:18:39 [ℹ]  created serviceaccount "kube-system/aws-load-balancer-controller"\n2021-11-29 18:18:39 [ℹ]  created serviceaccount "kube-system/ebs-csi-controller-sa"\n2021-11-29 18:18:41 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-external-dns-external-dns"\n2021-11-29 18:18:42 [ℹ]  created namespace "external-dns"\n2021-11-29 18:18:42 [ℹ]  created serviceaccount "external-dns/external-dns"\n2021-11-29 18:18:42 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-addon-iamserviceaccount-kube-system-efs-csi-controller-sa"\n2021-11-29 18:18:43 [ℹ]  created serviceaccount "kube-system/efs-csi-controller-sa"\n2021-11-29 18:18:43 [ℹ]  daemonset "kube-system/aws-node" restarted\n2021-11-29 18:18:43 [ℹ]  waiting for the control plane availability...\n2021-11-29 18:18:43 [✔]  saved kubeconfig as "/Users/ruzickap/git/k8s-eks-bottlerocket-fargate/kubeconfig-kube1.conf"\n2021-11-29 18:18:43 [ℹ]  no tasks\n2021-11-29 18:18:43 [✔]  all EKS cluster resources for "kube1" have been created\n2021-11-29 18:18:44 [ℹ]  kubectl command should work with "/Users/ruzickap/git/k8s-eks-bottlerocket-fargate/kubeconfig-kube1.conf", try \'kubectl --kubeconfig=/Users/ruzickap/git/k8s-eks-bottlerocket-fargate/kubeconfig-kube1.conf get nodes\'\n2021-11-29 18:18:44 [✔]  EKS cluster "kube1" in "eu-west-1" region is ready\ndaemonset.apps "aws-node" deleted\nconfigmap/calico-config created\ncustomresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/kubecontrollersconfigurations.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created\nclusterrole.rbac.authorization.k8s.io/calico-kube-controllers created\nclusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created\nclusterrole.rbac.authorization.k8s.io/calico-node created\nclusterrolebinding.rbac.authorization.k8s.io/calico-node created\ndaemonset.apps/calico-node created\nserviceaccount/calico-node created\ndeployment.apps/calico-kube-controllers created\nserviceaccount/calico-kube-controllers created\nWarning: policy/v1beta1 PodDisruptionBudget is deprecated in v1.21+, unavailable in v1.25+; use policy/v1 PodDisruptionBudget\npoddisruptionbudget.policy/calico-kube-controllers created\n2021-11-29 18:18:59 [ℹ]  eksctl version 0.75.0\n2021-11-29 18:18:59 [ℹ]  using region eu-west-1\n2021-11-29 18:19:15 [ℹ]  nodegroup "managed-ng-1" will use "" [Bottlerocket/1.21]\n2021-11-29 18:19:32 [ℹ]  1 nodegroup (managed-ng-1) was included (based on the include/exclude rules)\n2021-11-29 18:19:32 [ℹ]  will create a CloudFormation stack for each of 1 managed nodegroups in cluster "kube1"\n2021-11-29 18:19:32 [ℹ]\n2 sequential tasks: { fix cluster compatibility, 1 task: { 1 task: { create managed nodegroup "managed-ng-1" } }\n}\n2021-11-29 18:19:32 [ℹ]  checking cluster stack for missing resources\n2021-11-29 18:19:41 [ℹ]  cluster stack has all required resources\n2021-11-29 18:19:41 [ℹ]  building managed nodegroup stack "eksctl-kube1-nodegroup-managed-ng-1"\n2021-11-29 18:19:41 [ℹ]  deploying stack "eksctl-kube1-nodegroup-managed-ng-1"\n2021-11-29 18:19:41 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-nodegroup-managed-ng-1"\n...\n2021-11-29 18:22:59 [ℹ]  waiting for CloudFormation stack "eksctl-kube1-nodegroup-managed-ng-1"\n2021-11-29 18:23:00 [ℹ]  no tasks\n2021-11-29 18:23:00 [✔]  created 0 nodegroup(s) in cluster "kube1"\n2021-11-29 18:23:00 [ℹ]  nodegroup "managed-ng-1" has 3 node(s)\n2021-11-29 18:23:00 [ℹ]  node "ip-192-168-31-11.eu-west-1.compute.internal" is ready\n2021-11-29 18:23:00 [ℹ]  node "ip-192-168-56-82.eu-west-1.compute.internal" is ready\n2021-11-29 18:23:00 [ℹ]  node "ip-192-168-60-184.eu-west-1.compute.internal" is ready\n2021-11-29 18:23:00 [ℹ]  waiting for at least 2 node(s) to become ready in "managed-ng-1"\n2021-11-29 18:23:00 [ℹ]  nodegroup "managed-ng-1" has 3 node(s)\n2021-11-29 18:23:00 [ℹ]  node "ip-192-168-31-11.eu-west-1.compute.internal" is ready\n2021-11-29 18:23:00 [ℹ]  node "ip-192-168-56-82.eu-west-1.compute.internal" is ready\n2021-11-29 18:23:00 [ℹ]  node "ip-192-168-60-184.eu-west-1.compute.internal" is ready\n2021-11-29 18:23:00 [✔]  created 1 managed nodegroup(s) in cluster "kube1"\n2021-11-29 18:23:12 [ℹ]  checking security group configuration for all nodegroups\n2021-11-29 18:23:12 [ℹ]  all nodegroups have up-to-date cloudformation templates\n')])])]),s("p",[a._v("When the cluster is ready it immediately start pushing logs to CloudWatch under\n"),s("code",[a._v("/aws/eks/kube1/cluster")]),a._v(".")]),a._v(" "),s("p",[a._v("Add add the user or role to the aws-auth ConfigMap. This is handy if you are\nusing different user for cli operations and different user/role for accessing\nthe AWS Console to see EKS Workloads in Cluster's tab.")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("!")]),a._v(" eksctl get iamidentitymapping "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--cluster")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${CLUSTER_NAME}")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--region")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS_DEFAULT_REGION}")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--arn")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS_CONSOLE_ADMIN_ROLE_ARN}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("then")]),a._v("\n  eksctl create iamidentitymapping "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--cluster")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${CLUSTER_NAME}")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--region")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS_DEFAULT_REGION}")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--arn")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[a._v("${AWS_CONSOLE_ADMIN_ROLE_ARN}")]),a._v('"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--group")]),a._v(" system:masters "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("--username")]),a._v(" admin\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("fi")]),a._v("\n")])])]),s("p",[a._v("Output:")]),a._v(" "),s("div",{staticClass:"language-text extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v('2021-11-29 18:23:13 [ℹ]  eksctl version 0.75.0\n2021-11-29 18:23:13 [ℹ]  using region eu-west-1\n2021-11-29 18:23:14 [ℹ]  adding identity "arn:aws:iam::7xxxxxxxxxx7:role/AxxxxxxxxxxxxN" to auth ConfigMap\n')])])]),s("p",[a._v("Check the nodes+pods and max number of nodes which can be scheduled on one node:")]),a._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v("kubectl get nodes,pods "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-o")]),a._v(" wide --all-namespaces\n")])])]),s("p",[a._v("Output:")]),a._v(" "),s("div",{staticClass:"language-text extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("NAME                                                STATUS   ROLES    AGE   VERSION   INTERNAL-IP      EXTERNAL-IP     OS-IMAGE                               KERNEL-VERSION   CONTAINER-RUNTIME\nnode/ip-192-168-31-11.eu-west-1.compute.internal    Ready    &lt;none>   81s   v1.21.6   192.168.31.11    54.194.69.158   Bottlerocket OS 1.4.1 (aws-k8s-1.21)   5.10.68          containerd://1.5.5+bottlerocket\nnode/ip-192-168-56-82.eu-west-1.compute.internal    Ready    &lt;none>   86s   v1.21.6   192.168.56.82    3.250.52.238    Bottlerocket OS 1.4.1 (aws-k8s-1.21)   5.10.68          containerd://1.5.5+bottlerocket\nnode/ip-192-168-60-184.eu-west-1.compute.internal   Ready    &lt;none>   84s   v1.21.6   192.168.60.184   54.75.89.58     Bottlerocket OS 1.4.1 (aws-k8s-1.21)   5.10.68          containerd://1.5.5+bottlerocket\n\nNAMESPACE     NAME                                           READY   STATUS    RESTARTS   AGE     IP               NODE                                           NOMINATED NODE   READINESS GATES\nkube-system   pod/calico-kube-controllers-6c85b56fcb-5g5cq   1/1     Running   0          4m16s   172.16.166.130   ip-192-168-56-82.eu-west-1.compute.internal    &lt;none>           &lt;none>\nkube-system   pod/calico-node-4whs8                          1/1     Running   0          84s     192.168.60.184   ip-192-168-60-184.eu-west-1.compute.internal   &lt;none>           &lt;none>\nkube-system   pod/calico-node-nbjsn                          1/1     Running   0          86s     192.168.56.82    ip-192-168-56-82.eu-west-1.compute.internal    &lt;none>           &lt;none>\nkube-system   pod/calico-node-nnhwz                          1/1     Running   0          81s     192.168.31.11    ip-192-168-31-11.eu-west-1.compute.internal    &lt;none>           &lt;none>\nkube-system   pod/coredns-7cc879f8db-ct5bp                   1/1     Running   0          21m     172.16.166.131   ip-192-168-56-82.eu-west-1.compute.internal    &lt;none>           &lt;none>\nkube-system   pod/coredns-7cc879f8db-h4mbs                   1/1     Running   0          21m     172.16.166.129   ip-192-168-56-82.eu-west-1.compute.internal    &lt;none>           &lt;none>\nkube-system   pod/kube-proxy-9c9wk                           1/1     Running   0          86s     192.168.56.82    ip-192-168-56-82.eu-west-1.compute.internal    &lt;none>           &lt;none>\nkube-system   pod/kube-proxy-gqbt7                           1/1     Running   0          81s     192.168.31.11    ip-192-168-31-11.eu-west-1.compute.internal    &lt;none>           &lt;none>\nkube-system   pod/kube-proxy-q7pzh                           1/1     Running   0          84s     192.168.60.184   ip-192-168-60-184.eu-west-1.compute.internal   &lt;none>           &lt;none>\n")])])])])}),[],!1,null,null,null);s.default=n.exports}}]);