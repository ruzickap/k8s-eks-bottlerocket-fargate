<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Other workloads | Amazon EKS Bottlerocket and Fargate</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="https://raw.githubusercontent.com/kubernetes/kubernetes/d9a58a39b69a0eaec5797e0f7a0f9472b4829ab0/logo/logo.svg">
    <meta name="description" content="Amazon EKS Bottlerocket and Fargate">
    
    <link rel="preload" href="/k8s-eks-bottlerocket-fargate/assets/css/0.styles.61693ea3.css" as="style"><link rel="preload" href="/k8s-eks-bottlerocket-fargate/assets/js/app.cd5c61da.js" as="script"><link rel="preload" href="/k8s-eks-bottlerocket-fargate/assets/js/2.a27de003.js" as="script"><link rel="preload" href="/k8s-eks-bottlerocket-fargate/assets/js/1.30a6593f.js" as="script"><link rel="preload" href="/k8s-eks-bottlerocket-fargate/assets/js/30.7ac4c6d1.js" as="script"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/10.340b7a91.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/11.6724c971.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/12.0f6b2c7f.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/13.0f6f4ef5.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/14.28b41666.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/15.d3972987.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/16.4c24402c.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/17.6cd3a12a.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/18.8d7e6487.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/19.78b16bd4.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/20.a3f134b4.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/21.3fb0cd72.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/22.f5ea0076.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/23.a21f8ae6.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/24.c557dbf6.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/25.3d2180e6.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/26.8ac7134b.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/27.050bbf87.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/28.f566dccc.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/29.3e3635d0.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/3.6b4152e0.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/31.ee8b8daa.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/32.85f54686.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/33.b5ef35a1.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/34.6e2c7bbd.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/35.301a3049.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/4.bea5e217.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/5.ac8fedb2.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/6.76ff54c2.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/7.98538131.js"><link rel="prefetch" href="/k8s-eks-bottlerocket-fargate/assets/js/vendors~docsearch.d098b00c.js">
    <link rel="stylesheet" href="/k8s-eks-bottlerocket-fargate/assets/css/0.styles.61693ea3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/k8s-eks-bottlerocket-fargate/" class="home-link router-link-active"><img src="https://raw.githubusercontent.com/kubernetes/kubernetes/d9a58a39b69a0eaec5797e0f7a0f9472b4829ab0/logo/logo.svg" alt="Amazon EKS Bottlerocket and Fargate" class="logo"> <span class="site-name can-hide">Amazon EKS Bottlerocket and Fargate</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/k8s-eks-bottlerocket-fargate/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Links" class="dropdown-title"><span class="title">Links</span> <span class="arrow down"></span></button> <button type="button" aria-label="Links" class="mobile-dropdown-title"><span class="title">Links</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://aws.amazon.com/eks/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Amazon EKS
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://aws.amazon.com/bottlerocket/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Bottlerocket
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <a href="https://github.com/ruzickap/k8s-eks-bottlerocket-fargate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/k8s-eks-bottlerocket-fargate/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Links" class="dropdown-title"><span class="title">Links</span> <span class="arrow down"></span></button> <button type="button" aria-label="Links" class="mobile-dropdown-title"><span class="title">Links</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://aws.amazon.com/eks/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Amazon EKS
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://aws.amazon.com/bottlerocket/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Bottlerocket
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <a href="https://github.com/ruzickap/k8s-eks-bottlerocket-fargate" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/k8s-eks-bottlerocket-fargate/" aria-current="page" class="sidebar-link">Amazon EKS Bottlerocket and Fargate</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/#requirements" class="sidebar-link">Requirements</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/#content" class="sidebar-link">Content</a></li></ul></li><li><a href="/k8s-eks-bottlerocket-fargate/part-01/" class="sidebar-link">Amazon EKS Bottlerocket and Fargate</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-01/#requirements" class="sidebar-link">Requirements</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-01/#prepare-the-local-working-environment" class="sidebar-link">Prepare the local working environment</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-01/#configure-aws-route-53-domain-delegation" class="sidebar-link">Configure AWS Route 53 Domain delegation</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-01/#add-new-domain-to-route-53-policies-s3-ebs" class="sidebar-link">Add new domain to Route 53, Policies, S3, EBS</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-01/#create-amazon-eks" class="sidebar-link">Create Amazon EKS</a></li></ul></li><li><a href="/k8s-eks-bottlerocket-fargate/part-02/" class="sidebar-link">AWS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-02/#fargate" class="sidebar-link">Fargate</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-02/#aws-load-balancer-controller" class="sidebar-link">aws-load-balancer-controller</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-02/#aws-for-fluent-bit" class="sidebar-link">aws-for-fluent-bit</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-02/#aws-cloudwatch-metrics" class="sidebar-link">aws-cloudwatch-metrics</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-02/#aws-efs-csi-driver" class="sidebar-link">aws-efs-csi-driver</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-02/#install-external-snapshotter" class="sidebar-link">Install external-snapshotter</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-02/#aws-ebs-csi-driver" class="sidebar-link">aws-ebs-csi-driver</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-02/#test-amazon-eks-pod-limits" class="sidebar-link">Test Amazon EKS pod limits</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-02/#amazon-managed-prometheus-amazon-managed-grafana" class="sidebar-link">Amazon Managed Prometheus + Amazon Managed Grafana</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-02/#test-eks-access" class="sidebar-link">Test EKS access</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-02/#capsule" class="sidebar-link">Capsule</a></li></ul></li><li><a href="/k8s-eks-bottlerocket-fargate/part-03/" class="sidebar-link">Monitoring and Logging</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-03/#metrics-server" class="sidebar-link">metrics-server</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-03/#prometheus-adapter" class="sidebar-link">prometheus-adapter</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-03/#kube-prometheus-stack" class="sidebar-link">kube-prometheus-stack</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-03/#enable-calico-monitoring" class="sidebar-link">Enable calico monitoring</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-03/#loki" class="sidebar-link">loki</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-03/#aws-node-termination-handler" class="sidebar-link">aws-node-termination-handler</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-03/#kyverno" class="sidebar-link">kyverno</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-03/#nri-bundle" class="sidebar-link">nri-bundle</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-03/#splunk-connect" class="sidebar-link">splunk-connect</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-03/#aqua-security-enforcer" class="sidebar-link">Aqua Security Enforcer</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-03/#sysdig-agent" class="sidebar-link">sysdig-agent</a></li></ul></li><li><a href="/k8s-eks-bottlerocket-fargate/part-04/" class="sidebar-link">DNS, Ingress, Certificates</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-04/#cert-manager" class="sidebar-link">cert-manager</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-04/#kubed" class="sidebar-link">kubed</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-04/#ingress-nginx" class="sidebar-link">ingress-nginx</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-04/#istio-and-related-tools" class="sidebar-link">Istio and related tools</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-04/#external-dns" class="sidebar-link">external-dns</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-04/#mailhog" class="sidebar-link">mailhog</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-04/#kubewatch-obsolete" class="sidebar-link">kubewatch - obsolete</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-04/#calico-commands" class="sidebar-link">Calico commands</a></li></ul></li><li><a href="/k8s-eks-bottlerocket-fargate/part-05/" class="sidebar-link">Authentication</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-05/#keycloak" class="sidebar-link">Keycloak</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-05/#oauth2-proxy-keycloak" class="sidebar-link">oauth2-proxy - Keycloak</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-05/#dex" class="sidebar-link">Dex</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-05/#oauth2-proxy" class="sidebar-link">oauth2-proxy</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-05/#gangway" class="sidebar-link">Gangway</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-05/#kube-oidc-proxy" class="sidebar-link">kube-oidc-proxy</a></li></ul></li><li><a href="/k8s-eks-bottlerocket-fargate/part-06/" class="sidebar-link">Others</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-06/#cluster-autoscaler" class="sidebar-link">cluster-autoscaler</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-06/#descheduler" class="sidebar-link">Descheduler</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-06/#rancher" class="sidebar-link">Rancher</a></li></ul></li><li><a href="/k8s-eks-bottlerocket-fargate/part-07/" class="sidebar-link">Workloads</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-07/#podinfo" class="sidebar-link">podinfo</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-07/#polaris" class="sidebar-link">Polaris</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-07/#kubei" class="sidebar-link">kubei</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-07/#kube-bench" class="sidebar-link">kube-bench</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-07/#kubernetes-dashboard" class="sidebar-link">kubernetes-dashboard</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-07/#kubeview" class="sidebar-link">kubeview</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-07/#kube-ops-view" class="sidebar-link">kube-ops-view</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-07/#s3-upload-test" class="sidebar-link">S3 upload test</a></li></ul></li><li><a href="/k8s-eks-bottlerocket-fargate/part-08/" aria-current="page" class="active sidebar-link">Other workloads</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-08/#cluster-api" class="sidebar-link">Cluster API</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-08/#hashicorp-vault" class="sidebar-link">HashiCorp Vault</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-08/#podinfo-with-vault-certificate" class="sidebar-link">podinfo with vault certificate</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-08/#secrets-store-csi-driver" class="sidebar-link">secrets-store-csi-driver</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-08/#kuard" class="sidebar-link">kuard</a></li></ul></li><li><a href="/k8s-eks-bottlerocket-fargate/part-09/" class="sidebar-link">Drupal</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-09/#drupal-installation" class="sidebar-link">Drupal installation</a></li></ul></li><li><a href="/k8s-eks-bottlerocket-fargate/part-10/" class="sidebar-link">Harbor</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-10/#cloudwatch-retention" class="sidebar-link">CloudWatch retention</a></li></ul></li><li><a href="/k8s-eks-bottlerocket-fargate/part-11/" class="sidebar-link">Velero</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-11/#backup-vault-using-csi-volume-snapshotting" class="sidebar-link">Backup Vault using CSI Volume Snapshotting</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-11/#delete-restore-vault-using-csi-volume-snapshotting" class="sidebar-link">Delete + Restore Vault using CSI Volume Snapshotting</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-11/#backup-delete-restore-app-with-efs-storage-using-restic" class="sidebar-link">Backup + Delete + Restore app with EFS storage using restic</a></li></ul></li><li><a href="/k8s-eks-bottlerocket-fargate/part-12/" class="sidebar-link">GitOps tools</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-12/#argocd" class="sidebar-link">ArgoCD</a></li><li class="sidebar-sub-header"><a href="/k8s-eks-bottlerocket-fargate/part-12/#flux" class="sidebar-link">Flux</a></li></ul></li><li><a href="/k8s-eks-bottlerocket-fargate/part-13/" class="sidebar-link">Clean-up</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="other-workloads"><a href="#other-workloads" class="header-anchor">#</a> Other workloads</h1> <h2 id="cluster-api"><a href="#cluster-api" class="header-anchor">#</a> Cluster API</h2> <p>Install <code>clusterctl</code>:</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">set</span> <span class="token parameter variable">-x</span>

<span class="token assign-left variable">CLUSTERAPI_VERSION</span><span class="token operator">=</span><span class="token string">&quot;0.3.17&quot;</span>

<span class="token keyword">if</span> <span class="token operator">!</span> <span class="token builtin class-name">command</span> <span class="token parameter variable">-v</span> clusterctl <span class="token operator">&amp;&gt;</span> /dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-L</span> <span class="token string">&quot;https://github.com/kubernetes-sigs/cluster-api/releases/download/v<span class="token variable">${CLUSTERAPI_VERSION}</span>/clusterctl-<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">&quot;s/./\L&amp;/g&quot;</span><span class="token variable">)</span></span>-amd64&quot;</span> <span class="token parameter variable">-o</span> /usr/local/bin/clusterctl
  <span class="token function">chmod</span> +x /usr/local/bin/clusterctl
<span class="token keyword">fi</span>

<span class="token assign-left variable">CLUSTERAWSADM_VERSION</span><span class="token operator">=</span><span class="token string">&quot;0.6.6&quot;</span>
<span class="token keyword">if</span> <span class="token operator">!</span> <span class="token builtin class-name">command</span> <span class="token parameter variable">-v</span> clusterawsadm <span class="token operator">&amp;&gt;</span> /dev/null<span class="token punctuation">;</span> <span class="token keyword">then</span>
  <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-L</span> <span class="token string">&quot;https://github.com/kubernetes-sigs/cluster-api-provider-aws/releases/download/v<span class="token variable">${CLUSTERAWSADM_VERSION}</span>/clusterawsadm-<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">&quot;s/./\L&amp;/g&quot;</span><span class="token variable">)</span></span>-amd64&quot;</span> <span class="token parameter variable">-o</span> /usr/local/bin/clusterawsadm
  <span class="token function">chmod</span> +x /usr/local/bin/clusterawsadm
<span class="token keyword">fi</span>
</code></pre></div><p>The <code>clusterawsadm</code> utility takes the credentials that you set as environment
variables and uses them to create a CloudFormation stack in your AWS account
with the correct IAM resources:</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token assign-left variable">OIDC_PROVIDER_URL</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>aws eks describe-cluster <span class="token parameter variable">--name</span> <span class="token string">&quot;<span class="token variable">${CLUSTER_NAME}</span>&quot;</span> <span class="token parameter variable">--query</span> <span class="token string">&quot;cluster.identity.oidc.issuer&quot;</span> <span class="token parameter variable">--output</span> text<span class="token variable">)</span></span>
<span class="token builtin class-name">export</span> OIDC_PROVIDER_URL

<span class="token function">cat</span> <span class="token operator">&gt;</span> <span class="token string">&quot;tmp/<span class="token variable">${CLUSTER_FQDN}</span>/awsiamconfiguration.yaml&quot;</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
apiVersion: bootstrap.aws.infrastructure.cluster.x-k8s.io/v1alpha1
kind: AWSIAMConfiguration
spec:
  eks:
    enable: true
    iamRoleCreation: true
    defaultControlPlaneRole:
      disable: false
    managedMachinePool:
      disable: false
EOF</span>

clusterawsadm bootstrap iam create-cloudformation-stack <span class="token parameter variable">--config</span> <span class="token string">&quot;tmp/<span class="token variable">${CLUSTER_FQDN}</span>/awsiamconfiguration.yaml&quot;</span>
</code></pre></div><p>Output:</p> <div class="language-text extra-class"><pre class="language-text"><code>Attempting to create AWS CloudFormation stack cluster-api-provider-aws-sigs-k8s-io

Following resources are in the stack:

Resource                  |Type                                                                                |Status
AWS::IAM::InstanceProfile |control-plane.cluster-api-provider-aws.sigs.k8s.io                                  |CREATE_COMPLETE
AWS::IAM::InstanceProfile |controllers.cluster-api-provider-aws.sigs.k8s.io                                    |CREATE_COMPLETE
AWS::IAM::InstanceProfile |nodes.cluster-api-provider-aws.sigs.k8s.io                                          |CREATE_COMPLETE
AWS::IAM::ManagedPolicy   |arn:aws:iam::7xxxxxxxxxx7:policy/control-plane.cluster-api-provider-aws.sigs.k8s.io |CREATE_COMPLETE
AWS::IAM::ManagedPolicy   |arn:aws:iam::7xxxxxxxxxx7:policy/nodes.cluster-api-provider-aws.sigs.k8s.io         |CREATE_COMPLETE
AWS::IAM::ManagedPolicy   |arn:aws:iam::7xxxxxxxxxx7:policy/controllers.cluster-api-provider-aws.sigs.k8s.io   |CREATE_COMPLETE
AWS::IAM::Role            |control-plane.cluster-api-provider-aws.sigs.k8s.io                                  |CREATE_COMPLETE
AWS::IAM::Role            |controllers.cluster-api-provider-aws.sigs.k8s.io                                    |CREATE_COMPLETE
AWS::IAM::Role            |eks-controlplane.cluster-api-provider-aws.sigs.k8s.io                               |CREATE_COMPLETE
AWS::IAM::Role            |eks-nodegroup.cluster-api-provider-aws.sigs.k8s.io                                  |CREATE_COMPLETE
AWS::IAM::Role            |nodes.cluster-api-provider-aws.sigs.k8s.io                                          |CREATE_COMPLETE
</code></pre></div><p>Initialize the management cluster:</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">AWS_REGION</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${AWS_DEFAULT_REGION}</span>&quot;</span>
<span class="token assign-left variable">AWS_B64ENCODED_CREDENTIALS</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span>clusterawsadm bootstrap credentials encode-as-profile<span class="token variable">)</span></span>&quot;</span>
<span class="token builtin class-name">export</span> AWS_B64ENCODED_CREDENTIALS
<span class="token builtin class-name">export</span> <span class="token assign-left variable">EXP_EKS</span><span class="token operator">=</span>true
<span class="token builtin class-name">export</span> <span class="token assign-left variable">EXP_EKS_IAM</span><span class="token operator">=</span>true
<span class="token comment"># https://cluster-api-aws.sigs.k8s.io/topics/machinepools.html</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">EXP_MACHINE_POOL</span><span class="token operator">=</span>true
<span class="token comment"># https://blog.scottlowe.org/2021/03/02/deploying-a-cni-automatically-with-a-clusterresourceset/</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">EXP_CLUSTER_RESOURCE_SET</span><span class="token operator">=</span>true
kubectl get namespace capi-system <span class="token operator">&amp;&gt;</span> /dev/null <span class="token operator">||</span> clusterctl init <span class="token parameter variable">-v</span> <span class="token number">4</span> <span class="token parameter variable">--infrastructure</span><span class="token operator">=</span>aws --control-plane<span class="token operator">=</span><span class="token string">&quot;aws-eks:v<span class="token variable">${CLUSTERAWSADM_VERSION}</span>&quot;</span> <span class="token parameter variable">--bootstrap</span><span class="token operator">=</span><span class="token string">&quot;aws-eks:v<span class="token variable">${CLUSTERAWSADM_VERSION}</span>&quot;</span> <span class="token parameter variable">--core</span><span class="token operator">=</span><span class="token string">&quot;cluster-api:v<span class="token variable">${CLUSTERAPI_VERSION}</span>&quot;</span>

<span class="token comment"># Fix https://github.com/kubernetes-sigs/cluster-api-provider-aws/issues/2358</span>
kubectl apply <span class="token parameter variable">-f</span> - <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: capa-eks-control-plane-system-capa-eks-control-plane-manager-role
rules:
- apiGroups:
  - &quot;&quot;
  resources:
  - secrets
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - cluster.x-k8s.io
  resources:
  - clusters
  - clusters/status
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - controlplane.cluster.x-k8s.io
  resources:
  - awsmanagedcontrolplanes
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - controlplane.cluster.x-k8s.io
  resources:
  - awsmanagedcontrolplanes/status
  verbs:
  - get
  - patch
  - update
- apiGroups:
  - &quot;&quot;
  resources:
  - events
  verbs:
  - create
  - get
  - list
  - patch
  - watch
- apiGroups:
  - infrastructure.cluster.x-k8s.io
  resources:
  - awsclustercontrolleridentities
  - awsclusterroleidentities
  - awsclusterstaticidentities
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - infrastructure.cluster.x-k8s.io
  resources:
  - awsmachinepools
  - awsmachinepools/status
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - infrastructure.cluster.x-k8s.io
  resources:
  - awsmachines
  - awsmachines/status
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - infrastructure.cluster.x-k8s.io
  resources:
  - awsmanagedclusters
  - awsmanagedclusters/status
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - infrastructure.cluster.x-k8s.io
  resources:
  - awsmanagedmachinepools
  - awsmanagedmachinepools/status
  verbs:
  - get
  - list
  - watch
EOF</span>
</code></pre></div><p>Output:</p> <div class="language-text extra-class"><pre class="language-text"><code>WARNING: `encode-as-profile` should only be used for bootstrapping.

Installing the clusterctl inventory CRD
Fetching providers
Skipping installing cert-manager as it is already installed
Installing Provider=&quot;cluster-api&quot; Version=&quot;v0.3.17&quot; TargetNamespace=&quot;capi-system&quot;
Creating shared objects Provider=&quot;cluster-api&quot; Version=&quot;v0.3.17&quot;
Creating instance objects Provider=&quot;cluster-api&quot; Version=&quot;v0.3.17&quot; TargetNamespace=&quot;capi-system&quot;
Creating inventory entry Provider=&quot;cluster-api&quot; Version=&quot;v0.3.17&quot; TargetNamespace=&quot;capi-system&quot;
Installing Provider=&quot;bootstrap-aws-eks&quot; Version=&quot;v0.6.6&quot; TargetNamespace=&quot;capa-eks-bootstrap-system&quot;
Creating shared objects Provider=&quot;bootstrap-aws-eks&quot; Version=&quot;v0.6.6&quot;
Creating instance objects Provider=&quot;bootstrap-aws-eks&quot; Version=&quot;v0.6.6&quot; TargetNamespace=&quot;capa-eks-bootstrap-system&quot;
Creating inventory entry Provider=&quot;bootstrap-aws-eks&quot; Version=&quot;v0.6.6&quot; TargetNamespace=&quot;capa-eks-bootstrap-system&quot;
Installing Provider=&quot;control-plane-aws-eks&quot; Version=&quot;v0.6.6&quot; TargetNamespace=&quot;capa-eks-control-plane-system&quot;
Creating shared objects Provider=&quot;control-plane-aws-eks&quot; Version=&quot;v0.6.6&quot;
Creating instance objects Provider=&quot;control-plane-aws-eks&quot; Version=&quot;v0.6.6&quot; TargetNamespace=&quot;capa-eks-control-plane-system&quot;
Creating inventory entry Provider=&quot;control-plane-aws-eks&quot; Version=&quot;v0.6.6&quot; TargetNamespace=&quot;capa-eks-control-plane-system&quot;
Installing Provider=&quot;infrastructure-aws&quot; Version=&quot;v0.6.6&quot; TargetNamespace=&quot;capa-system&quot;
Creating shared objects Provider=&quot;infrastructure-aws&quot; Version=&quot;v0.6.6&quot;
Creating instance objects Provider=&quot;infrastructure-aws&quot; Version=&quot;v0.6.6&quot; TargetNamespace=&quot;capa-system&quot;
Creating inventory entry Provider=&quot;infrastructure-aws&quot; Version=&quot;v0.6.6&quot; TargetNamespace=&quot;capa-system&quot;

Your management cluster has been initialized successfully!

You can now create your first workload cluster by running the following:

  clusterctl config cluster [name] --kubernetes-version [version] | kubectl apply -f -

Warning: resource clusterroles/capa-eks-control-plane-system-capa-eks-control-plane-manager-role is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.
</code></pre></div><p>Create cluster:</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token assign-left variable">AWS_SSH_KEY_NAME</span><span class="token operator">=</span>eksctl-<span class="token variable">${CLUSTER_NAME}</span>-nodegroup-ng01-<span class="token variable"><span class="token variable">$(</span>ssh-keygen <span class="token parameter variable">-f</span> ~/.ssh/id_rsa.pub <span class="token parameter variable">-e</span> <span class="token parameter variable">-m</span> PKCS8 <span class="token operator">|</span> openssl pkey <span class="token parameter variable">-pubin</span> <span class="token parameter variable">-outform</span> DER <span class="token operator">|</span> openssl md5 <span class="token parameter variable">-c</span><span class="token variable">)</span></span> <span class="token comment"># DevSkim: ignore DS126858</span>
<span class="token builtin class-name">export</span> AWS_SSH_KEY_NAME

kubectl get namespace tenants <span class="token operator">&amp;&gt;</span> /dev/null <span class="token operator">||</span> kubectl create namespace tenants
kubectl apply <span class="token parameter variable">-f</span> - <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
apiVersion: controlplane.cluster.x-k8s.io/v1alpha3
kind: AWSManagedControlPlane
metadata:
  name: <span class="token variable">${CLUSTER_NAME}</span>1
  namespace: tenants
spec:
  additionalTags:
<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">${TAGS}</span>&quot;</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">&quot;s/ /<span class="token entity" title="\\">\\</span>n    /g; s/^/    /g; s/=/: /g&quot;</span><span class="token variable">)</span></span>
  eksClusterName: <span class="token variable">${CLUSTER_NAME}</span>1
  associateOIDCProvider: true
  region: &quot;<span class="token variable">${AWS_DEFAULT_REGION}</span>&quot;
  sshKeyName: &quot;<span class="token variable">${AWS_SSH_KEY_NAME}</span>&quot;
  # https://docs.aws.amazon.com/eks/latest/userguide/kubernetes-versions.html
  version: &quot;v1.20.4&quot;
  # Not working: https://github.com/kubernetes-sigs/cluster-api-provider-aws/issues/2409
  iamAuthenticatorConfig:
    mapRoles:
    - username: &quot;admin&quot;
      rolearn: &quot;<span class="token variable">${AWS_CONSOLE_ADMIN_ROLE_ARN}</span>&quot;
      groups:
      - &quot;system:masters&quot;
---
apiVersion: infrastructure.cluster.x-k8s.io/v1alpha3
kind: AWSManagedCluster
metadata:
  name: <span class="token variable">${CLUSTER_NAME}</span>1
  namespace: tenants
---
apiVersion: cluster.x-k8s.io/v1alpha3
kind: Cluster
metadata:
  name: <span class="token variable">${CLUSTER_NAME}</span>1
  namespace: tenants
  labels:
    type: tenant
spec:
  clusterNetwork:
    pods:
      cidrBlocks:
      - 192.168.0.0/16
  controlPlaneRef:
    apiVersion: controlplane.cluster.x-k8s.io/v1alpha3
    kind: AWSManagedControlPlane
    name: <span class="token variable">${CLUSTER_NAME}</span>1
  infrastructureRef:
    apiVersion: infrastructure.cluster.x-k8s.io/v1alpha3
    kind: AWSManagedCluster
    name: <span class="token variable">${CLUSTER_NAME}</span>1
---
apiVersion: infrastructure.cluster.x-k8s.io/v1alpha3
kind: AWSManagedMachinePool
metadata:
  name: <span class="token variable">${CLUSTER_NAME}</span>1-pool-0
  namespace: tenants
spec:
  amiType: AL2_x86_64
  diskSize: 10
  instanceType: t2.small
  eksNodegroupName: <span class="token variable">${CLUSTER_NAME}</span>1-ng
  scaling:
    minSize: 1
    maxSize: 3
---
apiVersion: exp.cluster.x-k8s.io/v1alpha3
kind: MachinePool
metadata:
  name: <span class="token variable">${CLUSTER_NAME}</span>1-pool-0
  namespace: tenants
spec:
  clusterName: <span class="token variable">${CLUSTER_NAME}</span>1
  replicas: 2
  template:
    spec:
      bootstrap:
        dataSecretName: &quot;&quot;
      clusterName: <span class="token variable">${CLUSTER_NAME}</span>1
      infrastructureRef:
        apiVersion: infrastructure.cluster.x-k8s.io/v1alpha3
        kind: AWSManagedMachinePool
        name: <span class="token variable">${CLUSTER_NAME}</span>1-pool-0
EOF</span>

kubectl <span class="token function">wait</span> <span class="token parameter variable">--for</span><span class="token operator">=</span>condition<span class="token operator">=</span>Ready <span class="token parameter variable">--timeout</span><span class="token operator">=</span>30m <span class="token parameter variable">-n</span> tenants machinepool <span class="token string">&quot;<span class="token variable">${CLUSTER_NAME}</span>1-pool-0&quot;</span>
</code></pre></div><p>Get cluster details:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get cluster,awsmanagedcontrolplane,machinepool,awsmanagedmachinepool,clusterresourceset <span class="token parameter variable">-n</span> tenants
</code></pre></div><p>Output:</p> <div class="language-text extra-class"><pre class="language-text"><code>NAME                              PHASE
cluster.cluster.x-k8s.io/kube11   Provisioned

NAME                                                          CLUSTER   READY   VPC                     BASTION IP
awsmanagedcontrolplane.controlplane.cluster.x-k8s.io/kube11   kube11    true    vpc-08aaa8fe61f860f65

NAME                                             REPLICAS   PHASE     VERSION
machinepool.exp.cluster.x-k8s.io/kube11-pool-0   2          Running

NAME                                                                  READY   REPLICAS
awsmanagedmachinepool.infrastructure.cluster.x-k8s.io/kube11-pool-0   true    2
</code></pre></div><p>Get the cluster details:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>clusterctl describe cluster --show-conditions all <span class="token parameter variable">-n</span> tenants <span class="token string">&quot;<span class="token variable">${CLUSTER_NAME}</span>1&quot;</span>
</code></pre></div><div class="language-text extra-class"><pre class="language-text"><code>NAME                                                READY  SEVERITY  REASON   SINCE  MESSAGE
/kube11                                             True                      3m10s
├─ClusterInfrastructure - AWSManagedCluster/kube11
└─ControlPlane - AWSManagedControlPlane/kube11      True                      3m8s
              ├─ClusterSecurityGroupsReady          True                      14m
              ├─EKSAddonsConfigured                 True                      3m9s
              ├─EKSControlPlaneCreating             False  Info      created  3m10s
              ├─EKSControlPlaneReady                True                      3m9s
              ├─IAMAuthenticatorConfigured          True                      3m8s
              ├─IAMControlPlaneRolesReady           True                      14m
              ├─InternetGatewayReady                True                      16m
              ├─NatGatewaysReady                    True                      14m
              ├─RouteTablesReady                    True                      14m
              ├─SubnetsReady                        True                      16m
              └─VpcReady                            True                      16m
</code></pre></div><p>Get kubeconfig for the new EKS cluster:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>clusterctl get kubeconfig <span class="token string">&quot;<span class="token variable">${CLUSTER_NAME}</span>1&quot;</span> <span class="token parameter variable">-n</span> tenants <span class="token operator">&gt;</span> <span class="token string">&quot;tmp/<span class="token variable">${CLUSTER_FQDN}</span>/kubeconfig-<span class="token variable">${CLUSTER_NAME}</span>1.conf&quot;</span>
</code></pre></div><p>Display details about all nodes in new cluster <code>kube11</code>:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span><span class="token string">&quot;tmp/<span class="token variable">${CLUSTER_FQDN}</span>/kubeconfig-<span class="token variable">${CLUSTER_NAME}</span>1.conf&quot;</span> get nodes <span class="token parameter variable">-L</span> node.kubernetes.io/instance-type <span class="token parameter variable">-L</span> topology.kubernetes.io/zone
</code></pre></div><p>Output:</p> <div class="language-text extra-class"><pre class="language-text"><code>NAME                                           STATUS   ROLES    AGE    VERSION              INSTANCE-TYPE   ZONE
ip-10-0-219-81.eu-central-1.compute.internal   Ready    &amp;lt;none&gt;   104s   v1.20.4-eks-6b7464   t2.small        eu-central-1c
ip-10-0-73-114.eu-central-1.compute.internal   Ready    &amp;lt;none&gt;   86s    v1.20.4-eks-6b7464   t2.small        eu-central-1a
</code></pre></div><p>Delete new EKS cluster:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl delete Cluster,AWSManagedControlPlane,MachinePool,AWSManagedMachinePool,ClusterResourceSet <span class="token parameter variable">-n</span> tenants <span class="token parameter variable">--all</span>
</code></pre></div><h2 id="hashicorp-vault"><a href="#hashicorp-vault" class="header-anchor">#</a> HashiCorp Vault</h2> <p>Install <code>vault</code> <a href="https://artifacthub.io/packages/helm/hashicorp/vault" target="_blank" rel="noopener noreferrer">helm chart<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
and modify the
<a href="https://github.com/hashicorp/vault-helm/blob/master/values.yaml" target="_blank" rel="noopener noreferrer">default values<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>helm repo <span class="token function">add</span> --force-update hashicorp https://helm.releases.hashicorp.com
helm upgrade <span class="token parameter variable">--install</span> <span class="token parameter variable">--version</span> <span class="token number">0.15</span>.0 <span class="token parameter variable">--namespace</span> vault <span class="token parameter variable">--wait</span> <span class="token parameter variable">--values</span> - vault hashicorp/vault <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
injector:
  enabled: false
server:
  ingress:
    enabled: true
    hosts:
      - host: vault.<span class="token variable">${CLUSTER_FQDN}</span>
    tls:
      - secretName: ingress-cert-<span class="token variable">${LETSENCRYPT_ENVIRONMENT}</span>
        hosts:
          - vault.<span class="token variable">${CLUSTER_FQDN}</span>
  dataStorage:
    size: 1Gi
    storageClass: gp3
  standalone:
    enabled: true
    config: |
      ui = true
      log_level = &quot;trace&quot;
      listener &quot;tcp&quot; {
        tls_disable = 1
        address = &quot;[::]:8200&quot;
        cluster_address = &quot;[::]:8201&quot;
      }
      seal &quot;awskms&quot; {
        region     = &quot;<span class="token variable">${AWS_DEFAULT_REGION}</span>&quot;
        kms_key_id = &quot;<span class="token variable">${KMS_KEY_ID}</span>&quot;
      }
      storage &quot;file&quot; {
        path = &quot;/vault/data&quot;
      }
  serviceAccount:
    create: false
    name: vault
EOF</span>
</code></pre></div><p>Wait for Vault to be ready:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">while</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">dig</span> +nocmd +noall +answer +ttlid a <span class="token string">&quot;vault.<span class="token variable">${CLUSTER_FQDN}</span>&quot;</span><span class="token variable">)</span></span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">dig</span> +nocmd +noall +answer +ttlid a <span class="token string">&quot;dex.<span class="token variable">${CLUSTER_FQDN}</span>&quot;</span><span class="token variable">)</span></span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token function">date</span>
  <span class="token function">sleep</span> <span class="token number">5</span>
<span class="token keyword">done</span>
</code></pre></div><p>Check the status of the vault server - it should be sealed and uninitialized:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-n</span> vault vault-0 -- vault status <span class="token operator">||</span> <span class="token boolean">true</span>
</code></pre></div><p>Output:</p> <div class="language-text extra-class"><pre class="language-text"><code>Key                      Value
---                      -----
Recovery Seal Type       awskms
Initialized              false
Sealed                   true
Total Recovery Shares    0
Threshold                0
Unseal Progress          0/0
Unseal Nonce             n/a
Version                  1.8.1
Storage Type             file
HA Enabled               false
</code></pre></div><p>Initialize the vault server:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">test</span> <span class="token parameter variable">-f</span> <span class="token string">&quot;tmp/<span class="token variable">${CLUSTER_FQDN}</span>/vault_cluster-keys.json&quot;</span> <span class="token operator">||</span> <span class="token punctuation">(</span>kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-n</span> vault vault-0 -- <span class="token string">&quot;/bin/sh&quot;</span> <span class="token string">&quot;-c&quot;</span> <span class="token string">&quot;export VAULT_CLIENT_TIMEOUT=500s &amp;&amp; vault operator init -format=json&quot;</span> <span class="token operator">|</span> <span class="token function">tee</span> <span class="token string">&quot;tmp/<span class="token variable">${CLUSTER_FQDN}</span>/vault_cluster-keys.json&quot;</span><span class="token punctuation">)</span>
<span class="token function">sleep</span> <span class="token number">10</span>
</code></pre></div><p>Output:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;unseal_keys_b64&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;unseal_keys_hex&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;unseal_shares&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;unseal_threshold&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;recovery_keys_b64&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;AzxM6NE0txz8tGBZYJUYMmkgxf5uNnHn0BNmLFzOnTAp&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;...&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;5yuvrqORnMRddsRccEixs83IkH4ilJak0h4d3AYytpds&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;recovery_keys_hex&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;033c4ce8d134b71cfcb46059609518326920c5fe6e3671e7d013662c5cce9d3029&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;...&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;e72bafaea3919cc45d76c45c7048b1b3cdc8907e229496a4d21e1ddc0632b6976c&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;recovery_keys_shares&quot;</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
  <span class="token property">&quot;recovery_keys_threshold&quot;</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token property">&quot;root_token&quot;</span><span class="token operator">:</span> <span class="token string">&quot;s.pxxxxxxxxxxxxxxxxxxxxxxU8&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The vault server should be initialized + unsealed now:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-n</span> vault vault-0 -- vault status
</code></pre></div><p>Output:</p> <div class="language-text extra-class"><pre class="language-text"><code>Key                      Value
---                      -----
Recovery Seal Type       shamir
Initialized              true
Sealed                   false
Total Recovery Shares    5
Threshold                3
Version                  1.8.1
Storage Type             file
Cluster Name             vault-cluster-35710bf5
Cluster ID               4b7168eb-6bfc-30fa-8ab9-060477394dc6
HA Enabled               false
</code></pre></div><p>Configure vault policy + authentication:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token assign-left variable">VAULT_ROOT_TOKEN</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>jq <span class="token parameter variable">-r</span> <span class="token string">&quot;.root_token&quot;</span> <span class="token string">&quot;tmp/<span class="token variable">${CLUSTER_FQDN}</span>/vault_cluster-keys.json&quot;</span><span class="token variable">)</span></span>
<span class="token builtin class-name">export</span> VAULT_ROOT_TOKEN
<span class="token builtin class-name">export</span> <span class="token assign-left variable">VAULT_ADDR</span><span class="token operator">=</span><span class="token string">&quot;https://vault.<span class="token variable">${CLUSTER_FQDN}</span>&quot;</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">VAULT_SKIP_VERIFY</span><span class="token operator">=</span><span class="token string">&quot;true&quot;</span>
<span class="token assign-left variable">VAULT_CLUSTER_FQDN</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">${CLUSTER_FQDN}</span>&quot;</span> <span class="token operator">|</span> <span class="token function">tr</span> <span class="token builtin class-name">.</span> -<span class="token variable">)</span></span>
<span class="token builtin class-name">export</span> VAULT_CLUSTER_FQDN
</code></pre></div><p>Login to vault as root user:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>vault login <span class="token string">&quot;<span class="token variable">${VAULT_ROOT_TOKEN}</span>&quot;</span>
</code></pre></div><p>Output:</p> <div class="language-text extra-class"><pre class="language-text"><code>Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run &quot;vault login&quot;
again. Future Vault requests will automatically use this token.

Key                  Value
---                  -----
token                s.pxxxxxxxxxxxxxxxxxxxxxx8
token_accessor       ruDTYdVBePlKKPn8bWVgWzi0
token_duration       ∞
token_renewable      false
token_policies       [&quot;root&quot;]
identity_policies    []
policies             [&quot;root&quot;]
</code></pre></div><p>Create admin policy:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&gt;</span> <span class="token string">&quot;tmp/<span class="token variable">${CLUSTER_FQDN}</span>/my-admin-policy.hcl&quot;</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
path &quot;*&quot; {
  capabilities = [&quot;create&quot;, &quot;read&quot;, &quot;update&quot;, &quot;delete&quot;, &quot;list&quot;, &quot;sudo&quot;]
}
EOF</span>
vault policy <span class="token function">write</span> my-admin-policy <span class="token string">&quot;tmp/<span class="token variable">${CLUSTER_FQDN}</span>/my-admin-policy.hcl&quot;</span>
</code></pre></div><p>Configure GitHub + Dex OIDC authentication:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">if</span> <span class="token operator">!</span> vault auth list <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-q</span> github<span class="token punctuation">;</span> <span class="token keyword">then</span>
  vault auth <span class="token builtin class-name">enable</span> github
  vault <span class="token function">write</span> auth/github/config <span class="token assign-left variable">organization</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${MY_GITHUB_ORG_NAME}</span>&quot;</span>
  vault <span class="token function">write</span> auth/github/map/teams/cluster-admin <span class="token assign-left variable">value</span><span class="token operator">=</span>my-admin-policy

  <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token string">&quot;<span class="token variable">${LETSENCRYPT_CERTIFICATE}</span>&quot;</span> <span class="token parameter variable">-o</span> <span class="token string">&quot;tmp/<span class="token variable">${CLUSTER_FQDN}</span>/letsencrypt.pem&quot;</span>
  vault auth <span class="token builtin class-name">enable</span> oidc
  <span class="token function">sleep</span> <span class="token number">10</span>
  vault <span class="token function">write</span> auth/oidc/config <span class="token punctuation">\</span>
    <span class="token assign-left variable">oidc_discovery_ca_pem</span><span class="token operator">=</span><span class="token string">&quot;@tmp/<span class="token variable">${CLUSTER_FQDN}</span>/letsencrypt.pem&quot;</span> <span class="token punctuation">\</span>
    <span class="token assign-left variable">oidc_discovery_url</span><span class="token operator">=</span><span class="token string">&quot;https://dex.<span class="token variable">${CLUSTER_FQDN}</span>&quot;</span> <span class="token punctuation">\</span>
    <span class="token assign-left variable">oidc_client_id</span><span class="token operator">=</span><span class="token string">&quot;vault.<span class="token variable">${CLUSTER_FQDN}</span>&quot;</span> <span class="token punctuation">\</span>
    <span class="token assign-left variable">oidc_client_secret</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${MY_PASSWORD}</span>&quot;</span> <span class="token punctuation">\</span>
    <span class="token assign-left variable">default_role</span><span class="token operator">=</span><span class="token string">&quot;my-oidc-role&quot;</span>
  vault <span class="token function">write</span> auth/oidc/role/my-oidc-role <span class="token punctuation">\</span>
    <span class="token assign-left variable">bound_audiences</span><span class="token operator">=</span><span class="token string">&quot;vault.<span class="token variable">${CLUSTER_FQDN}</span>&quot;</span> <span class="token punctuation">\</span>
    <span class="token assign-left variable">allowed_redirect_uris</span><span class="token operator">=</span><span class="token string">&quot;https://vault.<span class="token variable">${CLUSTER_FQDN}</span>/ui/vault/auth/oidc/oidc/callback,http://localhost:8250/oidc/callback&quot;</span> <span class="token punctuation">\</span>
    <span class="token assign-left variable">user_claim</span><span class="token operator">=</span><span class="token string">&quot;sub&quot;</span> <span class="token punctuation">\</span>
    <span class="token assign-left variable">policies</span><span class="token operator">=</span><span class="token string">&quot;my-admin-policy&quot;</span>
<span class="token keyword">fi</span>
</code></pre></div><p>You should be now able to login using OIDC (Dex):</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">rm</span> ~/.vault-token
vault login <span class="token parameter variable">-method</span><span class="token operator">=</span>oidc
vault secrets list
</code></pre></div><p>Output:</p> <div class="language-text extra-class"><pre class="language-text"><code>Complete the login via your OIDC provider. Launching browser to:

    https://dex.kube1.k8s.mylabs.dev/auth?client_id=vault.kube1.k8s.mylabs.dev&amp;amp;nonce=n_vaiwZVJEVlpDheqXUyUJ&amp;amp;redirect_uri=http%3A%2F%2Flocalhost%3A8250%2Foidc%2Fcallback&amp;amp;response_type=code&amp;amp;scope=openid&amp;amp;state=st_g4NPcYQyzjYT7nnoVWsK


Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run &quot;vault login&quot;
again. Future Vault requests will automatically use this token.

Key                  Value
---                  -----
token                s.9xxxxxxxxxxxxxxxxxxxxxxH
token_accessor       BXl2rAkOfDGLbH7y1Zu0Zmw3
token_duration       768h
token_renewable      true
token_policies       [&quot;default&quot; &quot;my-admin-policy&quot;]
identity_policies    []
policies             [&quot;default&quot; &quot;my-admin-policy&quot;]
token_meta_role      my-oidc-role

Path          Type         Accessor              Description
----          ----         --------              -----------
cubbyhole/    cubbyhole    cubbyhole_03a9c7e4    per-token private secret storage
identity/     identity     identity_3b8d49bf     identity store
sys/          system       system_654c1a4e       system endpoints used for control, policy and debugging
</code></pre></div><h3 id="generate-root-ca"><a href="#generate-root-ca" class="header-anchor">#</a> Generate Root CA</h3> <p>This should emulate your Company CA.
I used these guides to set it up:</p> <ul><li><a href="https://learn.hashicorp.com/tutorials/vault/kubernetes-external-vault?in=vault/kubernetes#install-the-vault-helm-chart" target="_blank" rel="noopener noreferrer">Integrate a Kubernetes Cluster with an External Vault<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://learn.hashicorp.com/tutorials/vault/kubernetes-cert-manager" target="_blank" rel="noopener noreferrer">Configure Vault as a Certificate Manager in Kubernetes with Helm<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://cert-manager.io/docs/configuration/vault/#authenticating-with-kubernetes-service-accounts" target="_blank" rel="noopener noreferrer">cert-manager Vault<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://learn.hashicorp.com/tutorials/vault/agent-kubernetes" target="_blank" rel="noopener noreferrer">Vault Agent with Kubernetes<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>Configure PKI secrets engine:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">if</span> <span class="token operator">!</span> vault secrets list <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">&quot;<span class="token variable">${VAULT_CLUSTER_FQDN}</span>-pki/&quot;</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
  vault secrets <span class="token builtin class-name">enable</span> <span class="token parameter variable">-path</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${VAULT_CLUSTER_FQDN}</span>-pki&quot;</span> pki
<span class="token keyword">fi</span>
</code></pre></div><p>Tune the <code>${VAULT_CLUSTER_FQDN}-pki</code> secrets engine to issue certificates with
a maximum time-to-live (TTL) of 87600 hours:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>vault secrets tune -max-lease-ttl<span class="token operator">=</span>87600h <span class="token string">&quot;<span class="token variable">${VAULT_CLUSTER_FQDN}</span>-pki&quot;</span>
</code></pre></div><p>Generate the <code>root</code> certificate and save the certificate in <code>CA_cert.crt</code>:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>vault <span class="token function">write</span> <span class="token parameter variable">-field</span><span class="token operator">=</span>certificate <span class="token string">&quot;<span class="token variable">${VAULT_CLUSTER_FQDN}</span>-pki/root/generate/internal&quot;</span> <span class="token punctuation">\</span>
  <span class="token assign-left variable">common_name</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${CLUSTER_FQDN}</span>&quot;</span> <span class="token assign-left variable">country</span><span class="token operator">=</span><span class="token string">&quot;CZ&quot;</span> <span class="token assign-left variable">organization</span><span class="token operator">=</span><span class="token string">&quot;PA&quot;</span> <span class="token punctuation">\</span>
  <span class="token assign-left variable">alt_names</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${CLUSTER_FQDN}</span>,*.<span class="token variable">${CLUSTER_FQDN}</span>&quot;</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span>87600h <span class="token operator">&gt;</span> <span class="token string">&quot;tmp/<span class="token variable">${CLUSTER_FQDN}</span>/CA_cert.crt&quot;</span>
</code></pre></div><p>Configure the PKI secrets engine certificate issuing and certificate revocation
list (CRL) endpoints to use the Vault service in the <code>vault</code> namespace:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>vault <span class="token function">write</span> <span class="token string">&quot;<span class="token variable">${VAULT_CLUSTER_FQDN}</span>-pki/config/urls&quot;</span> <span class="token punctuation">\</span>
  <span class="token assign-left variable">issuing_certificates</span><span class="token operator">=</span><span class="token string">&quot;https://vault.<span class="token variable">${CLUSTER_FQDN}</span>/v1/pki/ca&quot;</span> <span class="token punctuation">\</span>
  <span class="token assign-left variable">crl_distribution_points</span><span class="token operator">=</span><span class="token string">&quot;https://vault.<span class="token variable">${CLUSTER_FQDN}</span>/v1/pki/crl&quot;</span>
</code></pre></div><h3 id="generate-intermediate-ca"><a href="#generate-intermediate-ca" class="header-anchor">#</a> Generate Intermediate CA</h3> <p>Enable the <code>pki</code> secrets engine at the <code>${VAULT_CLUSTER_FQDN}-pki_int</code> path:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>vault secrets <span class="token builtin class-name">enable</span> <span class="token parameter variable">-path</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${VAULT_CLUSTER_FQDN}</span>-pki_int&quot;</span> pki
</code></pre></div><p>Tune the <code>${VAULT_CLUSTER_FQDN}-pki_int</code> secrets engine to issue certificates
with a maximum time-to-live (TTL) of 43800 hours:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>vault secrets tune -max-lease-ttl<span class="token operator">=</span>43800h <span class="token string">&quot;<span class="token variable">${VAULT_CLUSTER_FQDN}</span>-pki_int&quot;</span>
</code></pre></div><p>Execute the following command to generate an intermediate and save the
CSR as <code>pki_intermediate.csr</code>:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>vault <span class="token function">write</span> <span class="token parameter variable">-format</span><span class="token operator">=</span>json <span class="token string">&quot;<span class="token variable">${VAULT_CLUSTER_FQDN}</span>-pki_int/intermediate/generate/internal&quot;</span> <span class="token punctuation">\</span>
  <span class="token assign-left variable">common_name</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${CLUSTER_FQDN}</span>&quot;</span> <span class="token assign-left variable">country</span><span class="token operator">=</span><span class="token string">&quot;CZ&quot;</span> <span class="token assign-left variable">organization</span><span class="token operator">=</span><span class="token string">&quot;PA2&quot;</span> <span class="token punctuation">\</span>
  <span class="token assign-left variable">alt_names</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${CLUSTER_FQDN}</span>,*.<span class="token variable">${CLUSTER_FQDN}</span>&quot;</span> <span class="token operator">|</span>
  jq <span class="token parameter variable">-r</span> <span class="token string">&quot;.data.csr&quot;</span> <span class="token operator">&gt;</span> <span class="token string">&quot;tmp/<span class="token variable">${CLUSTER_FQDN}</span>/pki_intermediate.csr&quot;</span>
</code></pre></div><p>Sign the intermediate certificate with the root certificate and save the
generated certificate as <code>intermediate.cert.pem</code>:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>vault <span class="token function">write</span> <span class="token parameter variable">-format</span><span class="token operator">=</span>json <span class="token string">&quot;<span class="token variable">${VAULT_CLUSTER_FQDN}</span>-pki/root/sign-intermediate&quot;</span> <span class="token assign-left variable">csr</span><span class="token operator">=</span><span class="token string">&quot;@tmp/<span class="token variable">${CLUSTER_FQDN}</span>/pki_intermediate.csr&quot;</span> <span class="token punctuation">\</span>
  <span class="token assign-left variable">format</span><span class="token operator">=</span>pem_bundle <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token string">&quot;43800h&quot;</span> <span class="token operator">|</span>
  jq <span class="token parameter variable">-r</span> <span class="token string">&quot;.data.certificate&quot;</span> <span class="token operator">&gt;</span> <span class="token string">&quot;tmp/<span class="token variable">${CLUSTER_FQDN}</span>/intermediate.cert.pem&quot;</span>
</code></pre></div><p>Once the CSR is signed and the root CA returns a certificate, it can be
imported back into Vault:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>vault <span class="token function">write</span> <span class="token string">&quot;<span class="token variable">${VAULT_CLUSTER_FQDN}</span>-pki_int/intermediate/set-signed&quot;</span> <span class="token assign-left variable">certificate</span><span class="token operator">=</span><span class="token string">&quot;@tmp/<span class="token variable">${CLUSTER_FQDN}</span>/intermediate.cert.pem&quot;</span>
</code></pre></div><h3 id="configure-cert-manager-authentication-to-vault"><a href="#configure-cert-manager-authentication-to-vault" class="header-anchor">#</a> Configure cert-manager authentication to vault</h3> <p>I would like to simulate the scenario, where <code>cert-manager</code> will connect to
external Vault instance - therefore I can not use the Kubernetes authentication.
The vault instance is running on the same K8s cluster, but I will configure the
cert-manager to use <a href="https://cert-manager.io/docs/configuration/vault/#authenticating-via-an-approle" target="_blank" rel="noopener noreferrer">AppRole<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
to simulate &quot;external vault access&quot;.</p> <p>Enable the AppRole auth method:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>vault auth <span class="token builtin class-name">enable</span> approle
</code></pre></div><p>Create a policy that enables read access to the PKI secrets engine paths:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&gt;</span> <span class="token string">&quot;tmp/<span class="token variable">${CLUSTER_FQDN}</span>/pki_int_policy.hcl&quot;</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
path &quot;<span class="token variable">${VAULT_CLUSTER_FQDN}</span>-pki_int*&quot;                                              { capabilities = [&quot;read&quot;, &quot;list&quot;] }
path &quot;<span class="token variable">${VAULT_CLUSTER_FQDN}</span>-pki_int/roles/cert-manager-role-<span class="token variable">${VAULT_CLUSTER_FQDN}</span>&quot; { capabilities = [&quot;create&quot;, &quot;update&quot;] }
path &quot;<span class="token variable">${VAULT_CLUSTER_FQDN}</span>-pki_int/sign/cert-manager-role-<span class="token variable">${VAULT_CLUSTER_FQDN}</span>&quot;  { capabilities = [&quot;create&quot;, &quot;update&quot;] }
path &quot;<span class="token variable">${VAULT_CLUSTER_FQDN}</span>-pki_int/issue/cert-manager-role-<span class="token variable">${VAULT_CLUSTER_FQDN}</span>&quot; { capabilities = [&quot;create&quot;] }
EOF</span>
vault policy <span class="token function">write</span> <span class="token string">&quot;cert-manager-policy-<span class="token variable">${VAULT_CLUSTER_FQDN}</span>&quot;</span> <span class="token string">&quot;tmp/<span class="token variable">${CLUSTER_FQDN}</span>/pki_int_policy.hcl&quot;</span>
</code></pre></div><p>Create a named role:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>vault <span class="token function">write</span> <span class="token string">&quot;auth/approle/role/cert-manager-role-<span class="token variable">${VAULT_CLUSTER_FQDN}</span>&quot;</span> <span class="token assign-left variable">policies</span><span class="token operator">=</span><span class="token string">&quot;cert-manager-policy-<span class="token variable">${VAULT_CLUSTER_FQDN}</span>&quot;</span>
</code></pre></div><p>Configure a role that enables the creation of certificates for domain with any
subdomains:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>vault <span class="token function">write</span> <span class="token string">&quot;<span class="token variable">${VAULT_CLUSTER_FQDN}</span>-pki_int/roles/cert-manager-role-<span class="token variable">${VAULT_CLUSTER_FQDN}</span>&quot;</span> <span class="token punctuation">\</span>
  <span class="token assign-left variable">allowed_domains</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${CLUSTER_FQDN}</span>&quot;</span> <span class="token punctuation">\</span>
  <span class="token assign-left variable">allow_subdomains</span><span class="token operator">=</span>true <span class="token punctuation">\</span>
  <span class="token assign-left variable">max_ttl</span><span class="token operator">=</span>720h <span class="token punctuation">\</span>
  <span class="token assign-left variable">require_cn</span><span class="token operator">=</span>false
</code></pre></div><p>Get <code>secretId</code> and <code>roleId</code>:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token assign-left variable">VAULT_CERT_MANAGER_ROLE_ID</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>vault <span class="token builtin class-name">read</span> <span class="token string">&quot;auth/approle/role/cert-manager-role-<span class="token variable">${VAULT_CLUSTER_FQDN}</span>/role-id&quot;</span> <span class="token parameter variable">--format</span><span class="token operator">=</span>json <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> <span class="token string">&quot;.data.role_id&quot;</span><span class="token variable">)</span></span>
<span class="token assign-left variable">VAULT_CERT_MANAGER_SECRET_ID</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>vault <span class="token function">write</span> <span class="token parameter variable">-f</span> <span class="token string">&quot;auth/approle/role/cert-manager-role-<span class="token variable">${VAULT_CLUSTER_FQDN}</span>/secret-id&quot;</span> <span class="token parameter variable">--format</span><span class="token operator">=</span>json <span class="token operator">|</span> jq <span class="token parameter variable">-r</span> <span class="token string">&quot;.data.secret_id&quot;</span><span class="token variable">)</span></span>
</code></pre></div><p>Create K8s secret with <code>secretId</code>:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl apply <span class="token parameter variable">-f</span> - <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
apiVersion: v1
kind: Secret
type: Opaque
metadata:
  name: cert-manager-vault-approle
  namespace: cert-manager
data:
  secretId: &quot;<span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">echo</span> <span class="token string">&quot;<span class="token variable">${VAULT_CERT_MANAGER_SECRET_ID}</span>&quot;</span> <span class="token operator">|</span> base64<span class="token variable">)</span></span>&quot;
EOF</span>
</code></pre></div><p>Create an Issuer, named vault-issuer, that defines Vault as a certificate
issuer:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl apply <span class="token parameter variable">-f</span> - <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: vault-issuer
  namespace: cert-manager
spec:
  vault:
    path: <span class="token variable">${VAULT_CLUSTER_FQDN}</span>-pki_int/sign/cert-manager-role-<span class="token variable">${VAULT_CLUSTER_FQDN}</span>
    server: https://vault.<span class="token variable">${CLUSTER_FQDN}</span>
    caBundle: <span class="token variable"><span class="token variable">$(</span><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token string">&quot;<span class="token variable">${LETSENCRYPT_CERTIFICATE}</span>&quot;</span> <span class="token operator">|</span> base64 <span class="token parameter variable">-w0</span><span class="token variable">)</span></span>
    auth:
      appRole:
        path: approle
        roleId: &quot;<span class="token variable">${VAULT_CERT_MANAGER_ROLE_ID}</span>&quot;
        secretRef:
          name: cert-manager-vault-approle
          key: secretId
EOF</span>
</code></pre></div><p>Generate test certificate:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl get namespace podinfo-vault <span class="token operator">&amp;&gt;</span> /dev/null <span class="token operator">||</span> kubectl create namespace podinfo-vault
kubectl apply <span class="token parameter variable">-f</span> - <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: podinfo-vault-certificate
  namespace: podinfo-vault
spec:
  secretName: podinfo-vault-certificate-tls
  duration: 250h
  # Minimum of renewBefore should be 240h otherwise ingress-nginx will start complaining (https://github.com/kubernetes/ingress-nginx/blob/1b76ad70ca237fdd2a6ee1017cd16fda1908df90/internal/ingress/controller/controller.go#L1225)
  renewBefore: 240h
  subject:
    organizations:
    - MyLabs
  issuerRef:
    name: vault-issuer
    kind: ClusterIssuer
  commonName: &quot;*.vault-test-crt.<span class="token variable">${CLUSTER_FQDN}</span>&quot;
  dnsNames:
  - &quot;*.vault-test-crt.<span class="token variable">${CLUSTER_FQDN}</span>&quot;
  - &quot;vault-test-crt.<span class="token variable">${CLUSTER_FQDN}</span>&quot;
EOF</span>
<span class="token function">sleep</span> <span class="token number">5</span>
</code></pre></div><p>Check the certificates:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl get secrets <span class="token parameter variable">-n</span> podinfo-vault podinfo-vault-certificate-tls <span class="token parameter variable">--output</span><span class="token operator">=</span>jsonpath<span class="token operator">=</span><span class="token string">&quot;{.data.ca<span class="token entity" title="\\">\\</span>.crt}&quot;</span> <span class="token operator">|</span> base64 <span class="token parameter variable">--decode</span> <span class="token operator">|</span> openssl x509 <span class="token parameter variable">-text</span> <span class="token parameter variable">-noout</span>
kubectl get secrets <span class="token parameter variable">-n</span> podinfo-vault podinfo-vault-certificate-tls <span class="token parameter variable">--output</span><span class="token operator">=</span>jsonpath<span class="token operator">=</span><span class="token string">&quot;{.data.tls<span class="token entity" title="\\">\\</span>.crt}&quot;</span> <span class="token operator">|</span> base64 <span class="token parameter variable">--decode</span> <span class="token operator">|</span> openssl x509 <span class="token parameter variable">-text</span> <span class="token parameter variable">-noout</span>
kubectl get secrets <span class="token parameter variable">-n</span> podinfo-vault podinfo-vault-certificate-tls <span class="token parameter variable">--output</span><span class="token operator">=</span>jsonpath<span class="token operator">=</span><span class="token string">&quot;{.data.tls<span class="token entity" title="\\">\\</span>.key}&quot;</span> <span class="token operator">|</span> base64 <span class="token parameter variable">--decode</span> <span class="token operator">|</span> openssl rsa <span class="token parameter variable">-check</span>
</code></pre></div><p>Output:</p> <div class="language-text extra-class"><pre class="language-text"><code>Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            55:67:74:42:21:45:0d:a7:9c:c0:b1:0e:b0:f4:6c:83:f2:7d:06:cc
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: C=CZ, O=PA, CN=kube1.k8s.mylabs.dev
        Validity
            Not Before: Nov 29 18:03:20 2021 GMT
            Not After : Nov 28 18:03:50 2026 GMT
        Subject: CN=kube1.k8s.mylabs.dev
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
                    00:d9:e4:54:d5:4a:61:29:32:d4:83:eb:bf:02:eb:
...
                    97:7d
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Key Usage: critical
                Certificate Sign, CRL Sign
            X509v3 Basic Constraints: critical
                CA:TRUE
            X509v3 Subject Key Identifier:
                EC:BA:5D:62:E3:85:5E:42:DA:C4:AA:91:A0:9E:8A:0D:7D:27:22:B4
            X509v3 Authority Key Identifier:
                keyid:D7:E5:2D:A4:BE:E2:EA:8B:AF:50:21:A2:B6:58:B7:3B:05:22:06:3C

            Authority Information Access:
                CA Issuers - URI:https://vault.kube1.k8s.mylabs.dev/v1/pki/ca

            X509v3 Subject Alternative Name:
                DNS:kube1.k8s.mylabs.dev
            X509v3 CRL Distribution Points:

                Full Name:
                  URI:https://vault.kube1.k8s.mylabs.dev/v1/pki/crl

    Signature Algorithm: sha256WithRSAEncryption
         3f:61:24:e2:57:65:ea:41:1a:d6:1b:b0:8c:ef:85:51:41:0d:
...
         a6:72:d2:e7
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            30:f9:ca:e3:67:78:84:45:0e:0f:8b:05:bc:b3:9f:19:5c:ae:eb
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN=kube1.k8s.mylabs.dev
        Validity
            Not Before: Nov 29 18:03:42 2021 GMT
            Not After : Dec 10 04:04:12 2021 GMT
        Subject: CN=*.vault-test-crt.kube1.k8s.mylabs.dev
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
                    00:d9:4a:61:0e:41:67:ed:46:f6:32:8c:9b:b1:ab:
...
                    79:ab
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Key Usage: critical
                Digital Signature, Key Encipherment, Key Agreement
            X509v3 Extended Key Usage:
                TLS Web Server Authentication, TLS Web Client Authentication
            X509v3 Subject Key Identifier:
                88:5A:17:7D:0D:D8:96:E9:B4:F1:9C:46:2D:A2:44:BE:2F:01:0B:B6
            X509v3 Authority Key Identifier:
                keyid:EC:BA:5D:62:E3:85:5E:42:DA:C4:AA:91:A0:9E:8A:0D:7D:27:22:B4

            X509v3 Subject Alternative Name:
                DNS:*.vault-test-crt.kube1.k8s.mylabs.dev, DNS:vault-test-crt.kube1.k8s.mylabs.dev
    Signature Algorithm: sha256WithRSAEncryption
         b4:87:d8:1a:bd:dd:d8:3e:05:92:70:b7:d8:2c:a2:48:82:b3:
...
         6e:cc:32:d7
RSA key ok
writing RSA key
</code></pre></div><h2 id="podinfo-with-vault-certificate"><a href="#podinfo-with-vault-certificate" class="header-anchor">#</a> podinfo with vault certificate</h2> <p>Install <code>podinfo</code> <a href="https://github.com/stefanprodan/podinfo/releases" target="_blank" rel="noopener noreferrer">helm chart<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
and modify the
<a href="https://github.com/stefanprodan/podinfo/blob/master/charts/podinfo/values.yaml" target="_blank" rel="noopener noreferrer">default values<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>helm upgrade <span class="token parameter variable">--install</span> <span class="token parameter variable">--version</span> <span class="token number">6.0</span>.0 <span class="token parameter variable">--namespace</span> podinfo-vault <span class="token parameter variable">--values</span> - podinfo sp/podinfo <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
ui:
  message: &quot;Vault Certificate&quot;
serviceMonitor:
  enabled: true
ingress:
  enabled: true
  hosts:
    - host: podinfo.vault-test-crt.<span class="token variable">${CLUSTER_FQDN}</span>
      paths:
        - path: /
          pathType: ImplementationSpecific
  tls:
    - secretName: podinfo-vault-certificate-tls
      hosts:
        - podinfo.vault-test-crt.<span class="token variable">${CLUSTER_FQDN}</span>
EOF</span>
</code></pre></div><p>Wait for the DNS to be resolvable and service accessible:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token keyword">while</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> <span class="token parameter variable">-z</span> <span class="token string">&quot;<span class="token variable"><span class="token variable">$(</span><span class="token function">dig</span> +nocmd +noall +answer +ttlid a <span class="token string">&quot;podinfo.vault-test-crt.<span class="token variable">${CLUSTER_FQDN}</span>&quot;</span><span class="token variable">)</span></span>&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token function">date</span>
  <span class="token function">sleep</span> <span class="token number">5</span>
<span class="token keyword">done</span>
</code></pre></div><p>Check the certificate:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>openssl s_client <span class="token parameter variable">-connect</span> <span class="token string">&quot;podinfo.vault-test-crt.<span class="token variable">${CLUSTER_FQDN}</span>:443&quot;</span> <span class="token operator">&lt;</span> /dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> /dev/null <span class="token operator">||</span> <span class="token boolean">true</span> <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">&quot;/Server certificate/,/-----END CERTIFICATE-----/d&quot;</span> <span class="token operator">||</span> <span class="token boolean">true</span>
</code></pre></div><p>Output:</p> <div class="language-text extra-class"><pre class="language-text"><code>CONNECTED(00000006)
---
Certificate chain
 0 s:/O=Acme Co/CN=Kubernetes Ingress Controller Fake Certificate
   i:/O=Acme Co/CN=Kubernetes Ingress Controller Fake Certificate
---
Server certificate
-----BEGIN CERTIFICATE-----
MIIDbzCCAlegAwIBAgIQSB8G7xX+h6Td7daLPJ+hMDANBgkqhkiG9w0BAQsFADBL
...
MA05y3W7LmkeK0ebK4fr50SLFQ==
-----END CERTIFICATE-----
subject=/O=Acme Co/CN=Kubernetes Ingress Controller Fake Certificate
issuer=/O=Acme Co/CN=Kubernetes Ingress Controller Fake Certificate
---
No client certificate CA names sent
Server Temp Key: ECDH, X25519, 253 bits
---
SSL handshake has read 1357 bytes and written 289 bytes
---
New, TLSv1/SSLv3, Cipher is ECDHE-RSA-AES128-GCM-SHA256
Server public key is 2048 bit
Secure Renegotiation IS supported
Compression: NONE
Expansion: NONE
No ALPN negotiated
SSL-Session:
    Protocol  : TLSv1.2
    Cipher    : ECDHE-RSA-AES128-GCM-SHA256
    Session-ID: C53B8D0D70FE1C19FBDF7974A899C7328C42B499706F06F69B822D18426E3733
    Session-ID-ctx:
    Master-Key: 5xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx3
    Start Time: 1638209104
    Timeout   : 7200 (sec)
    Verify return code: 21 (unable to verify the first certificate)
---
</code></pre></div><h2 id="secrets-store-csi-driver"><a href="#secrets-store-csi-driver" class="header-anchor">#</a> secrets-store-csi-driver</h2> <ul><li><a href="https://docs.aws.amazon.com/secretsmanager/latest/userguide/integrating_csi_driver.html" target="_blank" rel="noopener noreferrer">Integrating Secrets Manager secrets with Kubernetes Secrets Store CSI Driver<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://aws.amazon.com/blogs/security/how-to-use-aws-secrets-configuration-provider-with-kubernetes-secrets-store-csi-driver/" target="_blank" rel="noopener noreferrer">How to use AWS Secrets &amp; Configuration Provider with your Kubernetes Secrets
Store CSI driver<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>Install <code>secrets-store-csi-driver</code> <a href="https://github.com/kubernetes-sigs/secrets-store-csi-driver/tree/master/charts/secrets-store-csi-driver" target="_blank" rel="noopener noreferrer">helm chart<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>
and modify the
<a href="https://github.com/kubernetes-sigs/secrets-store-csi-driver/blob/master/charts/secrets-store-csi-driver/values.yaml" target="_blank" rel="noopener noreferrer">default values<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>helm repo <span class="token function">add</span> --force-update secrets-store-csi-driver https://raw.githubusercontent.com/kubernetes-sigs/secrets-store-csi-driver/master/charts
helm upgrade <span class="token parameter variable">--install</span> <span class="token parameter variable">--version</span> <span class="token number">0.2</span>.0 <span class="token parameter variable">--namespace</span> kube-system <span class="token parameter variable">--values</span> - csi-secrets-store secrets-store-csi-driver/secrets-store-csi-driver <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
syncSecret:
  enabled: true
enableSecretRotation: true
EOF</span>
</code></pre></div><p>Install the AWS Provider:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl apply <span class="token parameter variable">-f</span> https://raw.githubusercontent.com/aws/secrets-store-csi-driver-provider-aws/main/deployment/aws-provider-installer.yaml
</code></pre></div><h2 id="kuard"><a href="#kuard" class="header-anchor">#</a> kuard</h2> <p>Create the SecretProviderClass which tells the AWS provider which secrets are
to be mounted in the pod:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl apply <span class="token parameter variable">-f</span> - <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
apiVersion: secrets-store.csi.x-k8s.io/v1alpha1
kind: SecretProviderClass
metadata:
  name: kuard-deployment-aws-secrets
  namespace: kuard
spec:
  provider: aws
  parameters:
    objects: |
        - objectName: &quot;<span class="token variable">${CLUSTER_FQDN}</span>-MySecret&quot;
          objectType: &quot;secretsmanager&quot;
          objectAlias: MySecret
        - objectName: &quot;<span class="token variable">${CLUSTER_FQDN}</span>-MySecret2&quot;
          objectType: &quot;secretsmanager&quot;
          objectAlias: MySecret2
  secretObjects:
  - secretName: mysecret
    type: Opaque
    data:
    - objectName: MySecret
      key: username
  - secretName: mysecret2
    type: Opaque
    data:
    - objectName: MySecret2
      key: username
EOF</span>
</code></pre></div><p>Install <a href="https://github.com/kubernetes-up-and-running/kuard" target="_blank" rel="noopener noreferrer">kuard<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl apply <span class="token parameter variable">-f</span> - <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
kind: Service
apiVersion: v1
metadata:
  name: kuard
  namespace: kuard
  labels:
    app: kuard
spec:
  selector:
    app: kuard
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kuard-deployment
  namespace: kuard
  labels:
    app: kuard
spec:
  replicas: 2
  selector:
    matchLabels:
      app: kuard
  template:
    metadata:
      labels:
        app: kuard
    spec:
      serviceAccountName: kuard
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - topologyKey: &quot;kubernetes.io/hostname&quot;
            labelSelector:
              matchLabels:
                app: kuard
      volumes:
      - name: secrets-store-inline
        csi:
          driver: secrets-store.csi.k8s.io
          readOnly: true
          volumeAttributes:
            secretProviderClass: &quot;kuard-deployment-aws-secrets&quot;
      containers:
      - name: kuard-deployment
        image: gcr.io/kuar-demo/kuard-amd64:v0.10.0-green
        resources:
          requests:
            cpu: 100m
            memory: &quot;64Mi&quot;
          limits:
            cpu: 100m
            memory: &quot;64Mi&quot;
        ports:
        - containerPort: 8080
        volumeMounts:
        - name: secrets-store-inline
          mountPath: &quot;/mnt/secrets-store&quot;
          readOnly: true
        env:
        - name: MYSECRET
          valueFrom:
            secretKeyRef:
              name: mysecret
              key: username
        - name: MYSECRET2
          valueFrom:
            secretKeyRef:
              name: mysecret2
              key: username
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: kuard
  namespace: kuard
  annotations:
    nginx.ingress.kubernetes.io/auth-url: https://oauth2-proxy.<span class="token variable">${CLUSTER_FQDN}</span>/oauth2/auth
    nginx.ingress.kubernetes.io/auth-signin: https://oauth2-proxy.<span class="token variable">${CLUSTER_FQDN}</span>/oauth2/start?rd=\<span class="token variable">$scheme</span>://\<span class="token variable">$host</span>\<span class="token variable">$request_uri</span>
  labels:
    app: kuard
spec:
  rules:
    - host: kuard.<span class="token variable">${CLUSTER_FQDN}</span>
      http:
        paths:
        - path: /
          pathType: ImplementationSpecific
          backend:
            service:
              name: kuard
              port:
                number: 8080
  tls:
    - hosts:
        - kuard.<span class="token variable">${CLUSTER_FQDN}</span>
      secretName: ingress-cert-<span class="token variable">${LETSENCRYPT_ENVIRONMENT}</span>
EOF</span>
</code></pre></div><p>Go to these URLs and check see the credentials synced from AWS Secrets Manager:</p> <ul><li><a href="https://kuard.kube1.k8s.mylabs.dev/-/env" target="_blank" rel="noopener noreferrer">https://kuard.kube1.k8s.mylabs.dev/-/env<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://kuard.kube1.k8s.mylabs.dev/fs/mnt/secrets-store/" target="_blank" rel="noopener noreferrer">https://kuard.kube1.k8s.mylabs.dev/fs/mnt/secrets-store/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>You should also see it in the <code>kuard</code> secret:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>kubectl <span class="token function">wait</span> <span class="token parameter variable">--namespace</span> kuard <span class="token parameter variable">--for</span> <span class="token assign-left variable">condition</span><span class="token operator">=</span>available deployment kuard-deployment
kubectl get secrets <span class="token parameter variable">-n</span> kuard mysecret <span class="token parameter variable">--template</span><span class="token operator">=</span><span class="token string">&quot;{{.data.username}}&quot;</span> <span class="token operator">|</span> base64 <span class="token parameter variable">-d</span> <span class="token operator">|</span> jq
</code></pre></div><p>Output:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;password&quot;</span><span class="token operator">:</span> <span class="token string">&quot;xxxxxx&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;username&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Administrator&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/ruzickap/k8s-eks-bottlerocket-fargate/edit/main/docs/part-08/README.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">6/30/2024, 4:19:34 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/k8s-eks-bottlerocket-fargate/part-07/" class="prev">
        Workloads
      </a></span> <span class="next"><a href="/k8s-eks-bottlerocket-fargate/part-09/">
        Drupal
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/k8s-eks-bottlerocket-fargate/assets/js/app.cd5c61da.js" defer></script><script src="/k8s-eks-bottlerocket-fargate/assets/js/2.a27de003.js" defer></script><script src="/k8s-eks-bottlerocket-fargate/assets/js/1.30a6593f.js" defer></script><script src="/k8s-eks-bottlerocket-fargate/assets/js/30.7ac4c6d1.js" defer></script>
  </body>
</html>
